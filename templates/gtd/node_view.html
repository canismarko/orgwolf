{% extends 'base.html' %}
{% load gtd_extras %}
{% comment %}
Copyright 2012 Mark Wolf

This file is part of OrgWolf.

OrgWolf is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% block title %}
{% if parent_node.title %}{{ parent_node.title }}
{% else %}Projects
{% endif %}
{% endblock %}
{% block style %}
<!-- Node view style block -->
{{ block.super }}
<style type="text/css">
.todo
{
    cursor: pointer;
}
</style>
{% endblock %}
{% block script %}
<!-- Node view script block -->
{{ block.super }}
<script>
$('document').ready(function() {
    // Aloha text editor
    Aloha.ready(function() {
    	$('#parent-text').alohaText();
    });
    // Project outline applicance
    var outline = new project_outline({
	$workspace: $('#outline-workspace'),
	todo_states: {% autoescape off %}{{ all_todo_states_json }}{% endautoescape %}
	});
    outline.init();
    {% if parent_node %}
    var update_todo = function ( todo_id ) {
	$('#parent-todo').todoState('update', { todo_id: todo_id });
	$('#edit-button').nodeEdit('update', { todo_id: todo_id });
	$('#todo-buttons').todoButtons('update', { todo_id: todo_id });
    };
    // todoState chooser for the parent's todo_state
    $('#parent-todo').todoState({
    	node_id: {{ parent_node.pk }},
    	states: {% autoescape off %}{{ all_todo_states_json_full }}{% endautoescape %},
	click: function(d) {
	    update_todo( d.todo_id );
	}
    });
    // Modal node edit form
    $('#edit-button').nodeEdit({
	url: '{% url 'gtd.views.edit_node' node_id=parent_node.pk %}',
	target: '#node-detail',
	callback: function(d) {
	    update_todo( d.todo_state );
	}				
    });
    // Todo buttons plugin
    $('#todo-buttons').todoButtons( { 
	callback: function(d) {
	    update_todo( d.todo_id );
	}
    });
    {% endif %}
});

</script>
{% endblock %}

{% block content %}
{# Search box #}
{% include "gtd/search_box.html" %}

<div id="node-detail">
{# Breadcrumb trail #}
    <a href="{{ base_url }}">Project List</a>
{% for node in breadcrumb_list %}&gt;
    <a href="{{ base_url }}{{node.pk}}/"{% if node.pk = parent_node.pk %} class="update" data-field="title"{% endif %}>{{node.display}}</a>
{% endfor %}

    <h3 class="update" data-field="title">{{ parent_node.get_title }}</h3>
    {% if node_id %}
  <form action="edit/" method="POST">
    <div class="btn-toolbar" id="todo-buttons" node_id="{{ parent_node.pk }}">
      <div class="btn-group">
	<a href="edit/" class="btn" id="edit-button">Edit</a><span class="alt"> |</span>
      </div>
      <div class="btn-group">
	<button type="submit" name="new_todo" value="0" class="btn new_todo{% if not parent_node.todo_state %} active{% endif %}">
	  [None]
	</button>
	{% for todo_state in all_todo_states_qs %}
	<button type="submit" name="new_todo" value="{{ todo_state.id }}" class="btn new_todo{% if todo_state = parent_node.todo_state %} active{% endif %}">
	  {{ todo_state.as_html }}
	</button>
	{% endfor %}
      </div>
    </div>
    <input type="hidden" name="function" value="change_todo_state" />
    {% csrf_token %}
  </form>
  {% endif %}

  {# Parent node item details #}
  <dl>
    {% include 'gtd/node_detail.html' %}
  </dl>

  <div node_id="{{ node_id }}">
    <div id="parent-text" class="update" data-field="text">
      {{ parent_node.text|escape_html }}
    </div>

    <form action="" method="POST" class="form-inline">
      <a href="new/" class="btn"><i class="icon-plus"></i>&nbsp;New Node</a>
      <div class="input-append">
	{% include "gtd/scope_filter.html" %}
	<input type="hidden" name="node_id" value="{{ parent_node.id }}" />
	<button type="submit" name="function" value="filter" class="btn">Filter</button>
      </div>
      {% csrf_token %}
    </form>
  </div>
</div><!-- /div id="node-detail"-->
{# List of child nodes as links #}
<div id="node-workspace">
  {% comment %}
  Used as a place to put twisty drop downs of all Nodes. 
  Populated with javascript
  {% endcomment %}
</div>
<div id="outline-workspace" node_id="{{ node_id }}">
  <table class="table" id="non-js-table" node_id="{{ node_id }}">
    <tr>
      <th>State</th>
      <th>Description</th>
      <th>Tags</th>
      <th>Actions</th>
    </tr>
    {% for node in child_nodes_qs %}
    <tr class="ow-heading" node_id="{{ node.id }}">
      <td class="ow-todo">{{ node.todo_state.as_html }}</td>
      <td class="ow-title">
	<a href="{{ base_url }}{{ node.id }}">{{ node.get_title }}</a>
      </td>
      <td class="ow-tags">{{ node.tag_string }}</td>
      <td class="ow-move">
	<form action="{% url 'gtd.views.edit_node' node.id %}" method="POST">
	  <div class="btn-group">
	    <button class="btn" type="submit" name="move_up"><i class="icon-arrow-up"></i><span class="alt">Up</span></button>
	    <button class="btn" type="submit" name="move_down"><i class="icon-arrow-down"></i><span class="alt">Down</span></button>
	  </div>
	  <input type="hidden" name="function" value="reorder"></input>
	  {% csrf_token %}
	</form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endblock %}
