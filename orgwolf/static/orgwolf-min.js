(function($,document,undefined){var pluses=/\+/g;function raw(s){return s}function decoded(s){return decodeURIComponent(s.replace(pluses," "))}var config=$.cookie=function(key,value,options){if(value!==undefined){options=$.extend({},config.defaults,options);if(value===null){options.expires=-1}if(typeof options.expires==="number"){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}value=config.json?JSON.stringify(value):String(value);return document.cookie=[encodeURIComponent(key),"=",config.raw?value:encodeURIComponent(value),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}var decode=config.raw?raw:decoded;var cookies=document.cookie.split("; ");for(var i=0,l=cookies.length;i<l;i++){var parts=cookies[i].split("=");if(decode(parts.shift())===key){var cookie=decode(parts.join("="));return config.json?JSON.parse(cookie):cookie}}return null};config.defaults={};$.removeCookie=function(key,options){if($.cookie(key)!==null){$.cookie(key,null,options);return true}return false}})(jQuery,document);"use strict";Array.prototype.order_by=function(field){var fields,sorted,compare,key,DATEFIELDS,direction;DATEFIELDS=["opened","closed","scheduled_date","deadline_date"];fields=/^(-)?(\S*)$/.exec(field);key=fields[2];sorted=this.slice(0);if(fields[1]==="-"){direction=-1}else{direction=1}compare=function(a,b){var a_val,b_val,num_a,num_b,response;if(a.fields===undefined||b.fields===undefined){a_val=a[key];b_val=b[key]}else if(a.fields.hasOwnProperty(key)&&b.fields.hasOwnProperty(key)){a_val=a.fields[key];b_val=b.fields[key]}else{a_val=a[key];b_val=b[key]}num_a=Number(a_val);num_b=Number(b_val);if(a.pk===0){response=-1;direction=1}else if(b.pk===0){response=1;direction=1}else if(DATEFIELDS.indexOf(key)>-1){response=new Date(a_val)-new Date(b_val)}else if(num_a&&num_b){response=num_a-num_b}else{if(typeof a_val!=="string"){a_val=""}if(typeof b_val!=="string"){b_val=""}a_val=a_val.toUpperCase();b_val=b_val.toUpperCase();if(a_val<b_val){response=-1}else if(a_val>b_val){response=1}else{response=0}}return response*direction};sorted.sort(compare);return sorted};Date.prototype.ow_date=function(){var s;s=this.getFullYear()+"-"+(this.getMonth()+1)+"-"+this.getDate();s=this.toISOString().slice(0,10);return s};"use strict";var HeadingFactory;angular.module("owServices",["ngResource","toaster"]).value("personaUser",null).factory("personaNavigator",["personaUser","$rootScope","$http","owWaitIndicator","activeState",function(personaUser,$rootScope,$http,owWaitIndicator,activeState){if(typeof navigator.id!=="undefined"){navigator.id.watch({loggedInUser:personaUser,onlogin:function(assertion){owWaitIndicator.start_wait("medium","persona");$http.post("/accounts/login/persona/",{assertion:assertion}).success(function(res,status,headers,config){owWaitIndicator.end_wait("medium","persona");activeState.user=res.user_id;$rootScope.$broadcast("refresh-data")}).error(function(xhr,status,err){navigator.id.logout();alert("Login failure: "+err)})},onlogout:function(){owWaitIndicator.start_wait("medium","persona");$http.post("/accounts/logout/persona/",{logout:true}).success(function(){window.location.reload()}).error(function(data,status,headers,config){alert("Logout failure: ")})}})}return navigator}]).factory("owWaitIndicator",["$rootScope",function($rootScope){var obj,end_wait;obj={waitLists:{quick:[],medium:[]},start_wait:function(listName,name){obj.waitLists[listName].push(name)},end_wait:function(listName,name){var lists,i;lists=obj.waitLists[listName];if(lists===undefined){name=listName;lists=[obj.waitLists.quick,obj.waitLists.medium]}else{lists=[lists]}for(i=0;i<lists.length;i+=1){end_wait(lists[i],name)}}};end_wait=function(list,name){var i;i=list.indexOf(name);while(i>-1){list.splice(i,1);i=list.indexOf(name)}};return obj}]).factory("Heading",["$http","$resource","toaster",function($http,$resource,toaster){var interceptor,res;interceptor={response:function(response){toaster.pop("success","Saved");return response},responseError:function(reason){toaster.pop("error","Error, not saved!","Check your internet connection and try again");console.log("Save failed:");console.log(reason)}};res=$resource("/gtd/nodes/:id/",{id:"@id",field_group:"@field_group"},{update:{method:"PUT",interceptor:interceptor},create:{method:"POST",interceptor:interceptor}});return res}]).factory("activeHeading",["Heading",function(Heading){var HeadingObj;HeadingObj={id:0,obj:null};HeadingObj.activate=function(HeadingId,requestData){var data;this.id=parseInt(HeadingId,10)||0;if(this.id){data=angular.extend({},{id:this.id},requestData);this.obj=Heading.get(data)}else{this.obj=null}};HeadingObj.ifActive=function(callback){if(this.obj){this.obj.$promise.then(callback)}};return HeadingObj}]).value("todoStatesList",[{id:1,color:{red:0,green:0,blue:0,alpha:0},abbreviation:"NEXT"},{id:2,color:{red:0,green:0,blue:0,alpha:0}}]).factory("todoStates",["$resource","todoStatesList",function($resource,todoStatesList){var states,TodoState;TodoState=$resource("/gtd/todostates/");states=TodoState.query();states=todoStatesList;states.getState=function(stateId){var foundState,foundStates;foundStates=this.filter(function(obj){return obj.id===stateId});if(foundStates.length>0){foundState=foundStates[0]}else{foundState=null}return foundState};return states}]).factory("focusAreas",["$resource","$rootScope",function($resource,$rootScope){var url,params,focusAreas,i;url="/gtd/focusareas/";params={is_visible:true};focusAreas=$resource(url).query(params);$rootScope.$on("refresh-data",function(){focusAreas.splice(0,focusAreas.length);$resource(url).query(params).$promise.then(function(newFocusAreas){for(i=0;i<newFocusAreas.length;i+=1){focusAreas.push(newFocusAreas[i])}})});return focusAreas}]).factory("GtdObject",["$resource","$rootScope",function($resource,$rootScope){return function(url,params){var objs;objs=$resource(url).query(params);$rootScope.$on("refresh-data",function(){contexts.splice(0,objs.length);$resource(url).query(params).$promise.then(function(newObjs){for(i=0;i<newObjs.length;i+=1){objs.push(newObjs[i])}})});return objs}}]).factory("contexts",["GtdObject",function(GtdObject){return GtdObject("/gtd/contexts",{})}]);"use strict";angular.module("owDirectives",["ngAnimate","ngResource","ngCookies","owServices","toaster"]).directive("personaButton",["personaNavigator","personaUser",function(personaNavigator,personaUser){function link(scope,element,attrs){element.on("click",function(){if(attrs.personaButton==="login"){personaNavigator.id.request()}else{personaNavigator.id.logout()}})}return{restrict:"AC",link:link}}]).directive("owSwitch",function(){function link($scope,$element,attrs,model){var $input;$input=$element.find("input");function formatter(value){$input.bootstrapSwitch("setState",value)}model.$formatters.push(formatter);$input.on("switch-change",function(e,data){if(data.value!==model.$modelValue){$scope.$apply(function(){model.$setViewValue(data.value)})}});$input.bootstrapSwitch()}return{link:link,require:"?ngModel"}}).directive("owWaitFeedback",["owWaitIndicator",function(owWaitIndicator){function link($scope,$element,attrs){var $mask;$mask=$element.find(".mask");$mask.hide();$element.hide();$scope.$watchCollection(function(){return owWaitIndicator.waitLists.quick.length},function(newLength){if(newLength>0){$element.show()}else{$element.hide()}});$scope.$watchCollection(function(){return owWaitIndicator.waitLists.medium.length},function(newLength){if(newLength>0){$element.show();$mask.show()}else{$element.hide();$mask.hide()}})}return{link:link,scope:{}}}]).directive("owCurrentDate",function(){function link($scope,$element,attrs){var $input;$input=$element.find("input");$scope.isEditable=false;function set_strings(newDate){$scope.dateString=newDate.toDateString();$scope.dateModel=newDate.ow_date();return newDate}$scope.$watch("currentDate",function(newDate){return set_strings(newDate)},true);$input.on("blur",function(){$scope.$apply(function(){var newDate;$scope.isEditable=false;newDate=new Date($scope.dateModel);if(isNaN(newDate)){set_strings($scope.currentDate)}else{$scope.currentDate.setDate(newDate.getUTCDate());$scope.currentDate.setMonth(newDate.getUTCMonth());$scope.currentDate.setYear(newDate.getUTCFullYear())}})})}return{link:link,templateUrl:"/static/current-date.html",scope:true}}).directive("owDetails",["$timeout",function($timeout){function link(scope,element,attrs){var i;scope.editorId="edit-text-"+scope.heading.id;scope.heading.$get().then(function(newHeading){scope.headingText=newHeading.text});$timeout(function(){if(typeof tinymce!=="undefined"){tinymce.init({plugins:"charmap fullscreen hr image link table textcolor",toolbar:"undo redo | fullscreen | styleselect | bold italic forecolor backcolor superscript subscript | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | hr link image",inline:true,tools:"inserttable",mode:"exact",elements:scope.editorId,setup:function(editor){editor.on("change",function(e){scope.$apply(function(){scope.heading.text=editor.getContent();scope.heading.$update()})})}})}});scope.editText=function(e){e.stopPropagation();scope.textIsEditable=true;scope.textEditStatus=""};scope.stopEditingText=function(){scope.textIsEditable=false;if(typeof tinymce!=="undefined"){tinymce.remove("#"+scope.editorId)}}}return{link:link,scope:{heading:"=owHeading"},templateUrl:"/static/details.html"}}]).directive("owEditable",["$resource","$rootScope","$timeout","owWaitIndicator","Heading","todoStates","focusAreas","toaster",function($resource,$rootScope,$timeout,owWaitIndicator,Heading,todoStates,focusAreas,toaster){function link(scope,element,attrs){var defaultParent,$text,heading,$save,heading_id,parent,editorId;scope.focusAreas=focusAreas;scope.todoStates=todoStates;scope.fields={};element.addClass("ow-editable");if(scope.heading){owWaitIndicator.start_wait("quick","editable");scope.fields=Heading.get({id:scope.heading.id});scope.fields.$promise.then(function(){owWaitIndicator.end_wait("editable")})}else if(scope.parent){scope.fields.focus_areas=scope.parent.focus_areas;scope.fields.priority=scope.parent.priority;scope.fields.parent=scope.parent.id}else{scope.fields.focus_areas=[];scope.fields.priority="B";if($rootScope.activeFocusArea&&$rootScope.activeFocusArea.id>0){scope.fields.focus_areas.push($rootScope.activeFocusArea.id)}}scope.priorities=[{sym:"A",display:"A - high"},{sym:"B",display:"B - medium (default)"},{sym:"C",display:"C - low"}];scope.time_units=[{value:"d",label:"Days"},{value:"w",label:"Weeks"},{value:"m",label:"Months"},{value:"y",label:"Years"}];scope.repeat_schemes=[{value:false,label:"scheduled date"},{value:true,label:"completion date"}];$text=element.find(".edit-text");$save=element.find("#edit-save");$("html").animate({scrollTop:element.offset().top-27},"500");scope.save=function(e){var newHeading;scope.fields.text=tinyMCE.get(scope.editorId).getContent();if(scope.heading){newHeading=Heading.update(scope.fields)}else{newHeading=Heading.create(scope.fields)}newHeading.$promise.then(function(data){scope.endEdit(newHeading)})};scope.editorId="editable-text-";if(scope.heading){scope.editorId+=scope.heading.id}else if(scope.parent){scope.editorId+="child-"+scope.parent.id}else{scope.editorId+="new"}$timeout(function(){if(typeof tinymce!=="undefined"){tinymce.init({plugins:"charmap fullscreen hr image link table textcolor",toolbar:"undo redo | fullscreen | styleselect | bold italic forecolor backcolor superscript subscript | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | hr link image",inline:true,tools:"inserttable",mode:"exact",elements:scope.editorId,auto_focus:false})}element.find("#title").focus()});scope.cancelEdit=function(e){scope.endEdit(e)};scope.endEdit=function(e){scope.$emit("finishEdit",e);scope.$parent.$parent.$eval(scope.finishCallback)}}return{link:link,scope:{heading:"=owHeading",parent:"=owParent",finishCallback:"@owEditFinish"},require:"?ngModel",templateUrl:"/static/editable.html"}}]).directive("owDraggable",[function(){function link(scope,element,attrs){var options,dragDropData;dragDropData={};options={handle:"> .ow-hoverable",zIndex:9999,helper:"clone",revert:"invalid",start:function(event,ui){dragDropData.list=scope.children;dragDropData.heading=scope.heading;$(element).data("dragDrop",dragDropData)}};jQuery(element).draggable(options)}return{link:link,scope:false}}]).directive("owDroppable",[function(){function link(scope,element,attrs){var openTwisty,options;options={drop:function(event,ui){var data,oldIdx,heading,oldList,newList;data=$(ui.draggable).data("dragDrop");heading=data.heading;oldList=data.list;oldIdx=oldList.indexOf(heading);var newParent=scope.heading;heading.parent=newParent?newParent.id:null;heading.$update().then(function(){oldList.splice(oldIdx,1);scope.loadedChildren=false;scope.getChildren()})},over:function(event,ui){element.addClass("droppable-over");var interval=1e3;openTwisty=setTimeout(function(){scope.$apply(function(){scope.toggleHeading(1)})},interval)},out:function(event,ui){element.removeClass("droppable-over");clearTimeout(openTwisty)},activate:function(event,ui){element.addClass("droppable-active")},deactivate:function(event,ui){element.removeClass("droppable-active");element.removeClass("droppable-over")}};scope.isValidMove=function(){};jQuery(element).droppable(options)}return{link:link,scope:false}}]).directive("owFocusAreaTabs",["$resource","$rootScope","$timeout","focusAreas",function($resource,$rootScope,$timeout,focusAreas){function link(scope,element,attrs){scope.nullFocusArea={id:0,display:"All"};scope.focusAreas=focusAreas;scope.activeFocusArea=scope.nullFocusArea;$rootScope.activeFocusArea=scope.nullFocusArea;$timeout(function(){element.find("#fa-tab-0").addClass("active")});scope.changeFocusArea=function(newFocusArea){element.find("#fa-tab-"+scope.activeFocusArea.id).removeClass("active");scope.activeFocusArea=newFocusArea;$rootScope.activeFocusArea=newFocusArea;element.find("#fa-tab-"+scope.activeFocusArea.id).addClass("active");$rootScope.$broadcast("focus-area-changed",newFocusArea)}}return{link:link,scope:{},templateUrl:"/static/focus-area-tabs.html"}}]).directive("owTodo",["$rootScope","$filter","todoStates","toaster",function($rootScope,$filter,todoStates,toaster){function link(scope,element,attrs){var i,$span,$popover,$options,state,content,s,isInitialized;element.addClass("todo-state-widget");scope.todoState=todoStates.getState(scope.heading.todo_state);scope.todoStateId=scope.heading.todo_state;scope.$watch("todoStateId",function(newStateId,oldStateId){if(newStateId!==scope.heading.todo_state){var oldDate;scope.heading.todo_state=parseInt(newStateId,10);scope.todoState=todoStates.getState(scope.heading.todo_state);scope.heading.auto_update=true;oldDate=scope.heading.scheduled_date;scope.heading.$update().then(function(response){scope.$emit("finishEdit",response.data,scope.todoState.closed);if(response.data.scheduled_date!==oldDate){var s="Rescheduled for ";s+=response.data.scheduled_date;toaster.pop("info",null,s)}})}});scope.$watch(function(){return scope.heading.todo_state},function(newHeadingStateId){if(newHeadingStateId!==scope.todoStateId){scope.todoState=todoStates.getState(scope.heading.todo_state);scope.todoStateId=newHeadingStateId}if(scope.todoState){element.tooltip({delay:{show:1e3,hide:100},title:scope.todoState.display_text})}})}function compile(cElement,cAttrs){var select,i,h,todoState;select=cElement.find("select");for(i=0;i<todoStates.length;i+=1){todoState=todoStates[i];h='<option value="'+todoState.id+'" ';h+='style="'+$filter("todoStateStyle")(todoState)+'">';h+=todoState.abbreviation+"</option>";select.append(h)}return link}return{compile:compile,scope:{heading:"=owHeading"},templateUrl:"/static/todo-state-selector.html"}}]).directive("owTwisty",["$compile","$rootScope","Heading","activeHeading",function($compile,$rootScope,Heading,activeHeading){function link(scope,element,attrs){var hoverable,get_children;scope.isEditing=false;scope.loadedChildren=false;scope.state=0;element.addClass("state-"+scope.state);scope.showArchived=$rootScope.showArchived;if($rootScope.todoStates){scope.todoStates=$rootScope.todoStates}else{scope.todoStates=[]}if(scope.todoState&&scope.todoState.actionable){element.find(".ow-hoverable").addClass("actionable")}scope.$on("toggle-archived",function(e,newState){scope.showArchived=newState});if(scope.heading.level===0){element.find(".ow-hoverable").addClass("project")}element.addClass("heading");hoverable=element.children(".ow-hoverable");scope.tags=scope.heading.tag_string.slice(1,-1).split(":");scope.$watch("heading.rght - heading.lft",function(newDiff){if(newDiff>1){hoverable.removeClass("leaf-node");scope.isLeafNode=false}else{hoverable.addClass("leaf-node");scope.isLeafNode=true}});scope.getChildren=function(){if(!scope.loadedChildren){scope.children=Heading.query({parent_id:scope.heading.id,field_group:"outline"});scope.children.$promise.then(function(headings){scope.numArchived=headings.filter(function(obj){return obj.archived===true}).length;scope.loadedChildren=true})}};scope.$on("open-descendants",function(e){if(e.targetScope!==e.currentScope){scope.toggleHeading(1)}});if(scope.heading.level>0){scope.getChildren()}scope.toggleHeading=function(newState){element.removeClass("state-"+scope.state);if(/^\d+$/.test(newState)){scope.state=newState%3}else if($(newState.target).is(":not(.non-opening)")){scope.state=(scope.state+1)%3;if(scope.isLeafNode&&scope.state===1){scope.state=2}}element.addClass("state-"+scope.state);if(scope.state>0){scope.getChildren()}if(scope.state===2){scope.$broadcast("open-descendants")}};scope.edit=function(e){var $off;e.stopPropagation();scope.isEditing=true;$off=scope.$on("finishEdit",function(event,newHeading){scope.isEditing=false;event.stopPropagation();if(newHeading){angular.extend(scope.heading,newHeading);if(scope.heading.todo_state){scope.todoState=scope.todoStates.filter(function(state){return state.id===scope.heading.todo_state})[0]}else{scope.todoState=null}}$off()})};scope.createChild=function(e){var $off;e.stopPropagation();if(scope.state===0){scope.toggleHeading(1)}scope.newChild=true;$off=scope.$on("finishEdit",function(event,newHeading){scope.newChild=false;event.stopPropagation();if(newHeading){scope.children.push(newHeading)}$off()})};scope.archive=function(e){e.stopPropagation();scope.heading.archived=!scope.heading.archived;scope.heading.$update()};activeHeading.ifActive(function(activeObj){var isAncestor=activeObj.tree_id===scope.heading.tree_id&&activeObj.lft>scope.heading.lft&&activeObj.rght<scope.heading.rght;if(activeObj.id===scope.heading.id){element.addClass("active-heading")}else if(isAncestor){scope.toggleHeading(1)}})}function compile(tElement,tAttr){var compiledContents,contents;contents=tElement.contents().remove();return function(scope,iElement,iAttr){if(!compiledContents){compiledContents=$compile(contents)}compiledContents(scope,function(clone,scope){iElement.append(clone);link(scope,iElement,iAttr)})}}return{compile:compile,templateUrl:"/static/outline-twisty.html",scope:{heading:"=owHeading"}}}]).directive("owListRow",["$rootScope","todoStates","$filter",function($rootScope,todoStates,$filter){function link(scope,element,attrs){var node_pk,$element;$element=$(element);element.addClass("heading-row");element.addClass("priority"+(scope.heading.priority||"B"));scope.todoState=todoStates.getState(scope.heading.todo_state);scope.$watch(function(){return scope.heading.deadline_date},function(newDeadline){var row_cls,due,today,deadline;due=null;if(newDeadline){today=new Date;deadline=new Date(newDeadline);scope.owDate=$filter("deadline_str")(newDeadline);due=deadline-today}element.removeClass("overdue");element.removeClass("upcoming");if(due===null){row_cls=""}else if(due<=0){row_cls="overdue"}else if(7*864e5>due>0){row_cls="upcoming"}element.addClass(row_cls)});scope.$watch("heading.fields.archived",function(archived){if(archived){element.addClass("archived")}});scope.$watch("heading.fields.priority",function(new_priority,old_priority){if(old_priority){element.removeClass("priority-"+old_priority)}if(new_priority){element.addClass("priority-"+new_priority)}});scope.edit=function(){var $off;scope.isEditable=true;$off=scope.$on("finishEdit",function(e){scope.isEditable=false;$off()})};scope.$on("finishEdit",function(e,newHeading,completed){e.stopPropagation();angular.extend(scope.heading,newHeading);scope.completed=completed})}return{link:link,scope:{heading:"=owHeading",owDate:"@"},templateUrl:"/static/actions-list-row.html"}}]);"use strict";var owFilters=angular.module("owFilters",["ngSanitize","owServices"]);owFilters.filter("is_target",function(){return function(obj,active){var answer="";if(active){if(obj.pk===active.id){answer="yes"}else if(obj.fields.tree_id===active.tree_id&&obj.fields.lft<active.lft&&obj.fields.rght>active.rght){answer="ancestor"}}return answer}});owFilters.filter("slugify",function(){return function(string){var s;if(string!==undefined){s=string.toLowerCase().replace(/[^a-z_]/g,"-")}return s}});owFilters.filter("todoStateStyle",function(){return function(obj){var style,c;style="";if(obj===null||obj===undefined){style=null}else{c=obj.color;style+="color: rgba("+c.red+", "+c.green+", ";style+=c.blue+", "+c.alpha+"); "}return style}});owFilters.filter("headingStyle",function(){return function(obj){var style,colors,color_i;style="";if(obj.level>0){colors=["rgb(80, 0, 0)","rgb(0, 44, 19)","teal","slateblue","brown"];color_i=obj.level%colors.length;style+="color: "+colors[color_i-1]+"; "}return style}});owFilters.filter("asHtml",["$sce",function($sce){return function(obj){var s=$sce.trustAsHtml(obj);return s}}]);owFilters.filter("order",["$sce",function($sce){return function(obj,criterion,activeHeading){var ordered,deadline,other,i;if(criterion==="list"){other=obj.filter(function(currHeading){var today,deadline,isOther,delta;isOther=false;if(currHeading.deadline_date===null){isOther=true}else{today=new Date;deadline=new Date(currHeading.deadline_date);delta=deadline-today;if(delta>7*24*3600*1e3){isOther=true}}return isOther});deadline=$(obj).not(other).get().order_by("deadline_date");ordered=deadline;ordered=ordered.concat(other.order_by("priority"))}else if(criterion==="none"){ordered=obj}else{ordered=obj.order_by(criterion)}if(activeHeading){for(i=0;i<ordered.length;i+=1){if(ordered[i].tree_id===activeHeading.tree_id){ordered.unshift(ordered.splice(i,1)[0])}}}return ordered}}]);owFilters.filter("currentList",function(){return function(headings,todoStates,upcomingList,activeParent){var upcomingListIds;if(todoStates){headings=headings.filter(function(h){return todoStates.indexOf(h.todo_state)>-1})}if(upcomingList){upcomingListIds=upcomingList.map(function(v){return v.id});headings=headings.filter(function(h){return upcomingListIds.indexOf(h.id)===-1})}if(activeParent){headings=headings.filter(function(h){var isDescendant;if(h.tree_id===activeParent.tree_id&&h.lft>=activeParent.lft&&h.rght<=activeParent.rght){isDescendant=true}else{isDescendant=false}return isDescendant})}return headings}});owFilters.filter("deadline_str",["$sce",function($sce){return function(deadline,today){var str,date,time_delta,day_delta;if(typeof today==="undefined"){today=new Date}str="";if(deadline){str="Due ";date=new Date(deadline+"T12:00:00");today.setHours(12,0,0,0);time_delta=date.getTime()-today.getTime();day_delta=Math.ceil(time_delta/(1e3*3600*24));if(day_delta===0){str+="today"}else if(day_delta===-1){str+="yesterday"}else if(day_delta<0){str+=Math.abs(day_delta)+" days ago"}else if(day_delta===1){str+="tomorrow"}else if(day_delta>0){str+="in "+day_delta+" days"}}return str}}]);owFilters.filter("duration",function(){return function(node){var str,days,hours,minutes,pluralize,start,end,diff;days=hours=minutes=0;if(node.scheduled_time&&node.end_time){start=new Date(node.scheduled_date+"T"+node.scheduled_time);end=new Date(node.end_date+"T"+node.end_time)}else{start=new Date(node.scheduled_date);end=new Date(node.end_date)}diff=end.getTime()-start.getTime();days=Math.floor(diff/(1e3*3600*24));diff=diff%(1e3*3600*24);hours=Math.floor(diff/(1e3*3600));diff=diff%(1e3*3600);minutes=Math.floor(diff/(1e3*60));pluralize=function(num,singular,plural){var s="";if(num){s+=num+" ";if(Math.abs(num)>1){s+=plural}else{s+=singular}s+=", "}return s};str="";if(days){str+=pluralize(days,"day","days")}if(hours){str+=pluralize(hours,"hour","hours")}if(minutes){str+=pluralize(minutes,"minute","minutes")}str=str.substring(0,str.length-2);return str}});owFilters.filter("currentFocusArea",["$rootScope",function($rootScope){return function(oldList,activeFocusArea){var i,newList,activeId;if(typeof activeFocusArea==="undefined"&&$rootScope.activeFocusArea){activeId=parseInt($rootScope.activeFocusArea.id,10)}else if(activeFocusArea){activeId=parseInt(activeFocusArea.id,10)}else{activeId=0}if(activeId){newList=[];for(i=0;i<oldList.length;i+=1){if(oldList[i].focus_areas.indexOf(activeId)>-1){newList.push(oldList.slice(i,i+1)[0])}}}else{newList=oldList.slice(0)}return newList}}]);owFilters.filter("listFocusAreas",["focusAreas",function(focusAreas){return function(heading){var s,f,i,fa,activeFocusAreas,areaName;activeFocusAreas=[];f=function(fa){return fa.id===heading.focus_areas[i]};for(i=0;i<heading.focus_areas.length;i+=1){areaName=focusAreas.filter(f)[0];activeFocusAreas.push(areaName)}s="";for(i=0;i<activeFocusAreas.length;i+=1){fa=activeFocusAreas[i];if(i===0){s+=fa.display}else if(i===activeFocusAreas.length-1&&activeFocusAreas.length>1){s+=" and "+fa.display}else{s+=", "+fa.display}}return s}}]).filter("highlightSearch",[function(){return function(sourceString,reString){var i,regex;regex=new RegExp(reString,"ig");sourceString=sourceString.replace(regex,'<span class="highlight">$&</span>');return sourceString}}]).filter("highlightSearchText",[function(){return function(sourceText,reString){var regex,workingString,firstMatch;sourceText=String(sourceText).replace(/<[^>]+>/gm,"");regex=new RegExp(reString,"ig");firstMatch=sourceText.search(regex);if(firstMatch>-1){if(firstMatch>40){sourceText="&hellip;"+sourceText.slice(firstMatch-40)}if(sourceText.length>500){sourceText=sourceText.slice(0,500);sourceText+="&hellip;"}}else{sourceText=""}return sourceText}}]);"use strict";var test_headings,owConfig,HeadingFactory,outlineCtrl,listCtrl;angular.module("owMain",["ngAnimate","ngResource","ngSanitize","ngRoute","ngCookies","ui.bootstrap","ui.calendar","toaster","owServices","owDirectives","owFilters"]).config(["$routeProvider","$locationProvider",function($routeProvider,$locationProvider){$locationProvider.html5Mode({enabled:true,requireBase:false});$routeProvider.when("/gtd/actions/:context_id?/:context_slug?",{templateUrl:"/static/actions-list.html",controller:"nextActionsList",reloadOnSearch:false}).when("/gtd/projects/",{templateUrl:"/static/project-outline.html",controller:"nodeOutline"}).when("/search/",{templateUrl:"/static/search-results.html",controller:"search"}).when("/calendar/",{templateUrl:"/static/calendar.html",controller:"calendar"}).when("/",{redirectTo:"/gtd/projects/"})}]).config(["$httpProvider","$locationProvider",function($httpProvider,$locationProvider){$httpProvider.defaults.headers.common["X-Request-With"]="XMLHttpRequest";$httpProvider.defaults.xsrfCookieName="csrftoken";$httpProvider.defaults.xsrfHeaderName="X-CSRFToken";function getCookie(name){var cookieValue,cookies,i,cookie;cookieValue=null;if(document.cookie&&document.cookie!==""){cookies=document.cookie.split(";");for(i=0;i<cookies.length;i+=1){cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)===name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}var csrftoken=getCookie("csrftoken");jQuery.ajaxSetup({beforeSend:function(xhr){xhr.setRequestHeader("X-CSRFToken",csrftoken)}})}]).run(["$rootScope","$location",function($rootScope,$location){$rootScope.$on("$routeChangeSuccess",function(){if(typeof ga!=="undefined"){ga("send","pageview",{page:$location.path()})}})}]).controller("inboxCapture",["$scope","$rootScope","owWaitIndicator",function($scope,$rootScope,owWaitIndicator){$scope.capture=function(e){var text,data,$textbox;data={handler_path:"plugins.quickcapture"};$textbox=$(e.target).find("#new_inbox_item");data.subject=$textbox.val();owWaitIndicator.start_wait("medium","quickcapture");jQuery.ajax("/wolfmail/message/",{type:"POST",data:data,complete:function(){$scope.$apply(function(){owWaitIndicator.end_wait("quickcapture")})},success:function(){$textbox.val("");$rootScope.$emit("refresh_messages")},error:function(jqXHR,status,error){alert("Failed!");console.log(status);console.log(error)}})}}]).controller("nodeOutline",["$scope","$rootScope","$http","$resource","$filter","Heading","$location","$anchorScroll","owWaitIndicator","activeHeading",function outlineCtrl($scope,$rootScope,$http,$resource,$filter,Heading,$location,$anchorScroll,owWaitIndicator,activeHeading){var TodoState,Scope,url,get_heading,Parent,Tree,parent_tree_id,parent_level,target_headings,targetId,main_headings,newButton,showAllButton;newButton=$("#add-heading");showAllButton=$("#show-all");activeHeading.activate($location.hash().split("-")[0]);$scope.activeHeading=activeHeading;$scope.getChildren=function(){$scope.children=Heading.query({parent_id:0,archived:false,field_group:"outline"})};$scope.getChildren();$scope.toggleHeading=function(state){};$scope.activeScope=null;$scope.sortField="title";$scope.sortFields=[{key:"title",display:"Title"},{key:"-title",display:"Title (reverse)"},{key:"-opened",display:"Creation date"},{key:"opened",display:"Creation date (oldest first)"}];if($scope.parent_id===""){$scope.parent_id=0}else{$scope.parent_id=parseInt($scope.parent_id,10)}$rootScope.showArchived=false;if($scope.parent_id){target_headings=Heading.query({tree_id:parent_tree_id,level__lte:parent_level+1});$scope.headings.add(target_headings);target_headings.$promise.then(function(){var target,open;target=$scope.headings.get({pk:$scope.parent_id});open=function(child){var parent;child.toggle("open");child.update();parent=child.get_parent();if(parent.rank!==0){open(parent)}};if(target.fields.archived){$rootScope.showArchived=true}open(target);target.editable=true})}$scope.showAll=function(e){var arx_headings;$rootScope.showArchived=!$rootScope.showArchived;showAllButton.toggleClass("active");if(!$scope.arx_cached){arx_headings=Heading.query({parent_id:0,archived:true});arx_headings.$promise.then(function(){$scope.children=$scope.children.concat(arx_headings)});$scope.arx_cached=true}$scope.$broadcast("toggle-archived",$rootScope.showArchived)};$scope.addProject=function(e){var $off;$scope.newProject=!$scope.newProject;newButton.toggleClass("active");$off=$scope.$on("finishEdit",function(e,newHeading){e.stopPropagation();$scope.newProject=false;newButton.removeClass("active");if(newHeading){$scope.sortFields.unshift({key:"none",display:"None"});$scope.children=$filter("order")($scope.children,$scope.sortField);$scope.sortField="none";$scope.children.unshift(newHeading)}$off()})};$scope.$on("refresh-data",$scope.getChildren);$scope.$on("focus-area-changed",function(e,newFocusArea){$scope.activeFocusArea=newFocusArea})}]).controller("nextActionsList",["$sce","$scope","$resource","$location","$routeParams","$filter","contexts","Heading","todoStates","owWaitIndicator","$cookies",function listCtrl($sce,$scope,$resource,$location,$routeParams,$filter,contexts,Heading,todoStates,owWaitIndicator,$cookies){var i,TodoState,Context,today,update_url,get_list,parent_id,todo_states;$scope.list_params={field_group:"actions_list"};$scope.showArchived=true;$scope.todoStates=todoStates;$scope.contexts=contexts;$scope.activeScope=null;if(typeof $routeParams.context_id!=="undefined"){$scope.activeContext=parseInt($routeParams.context_id,10);$scope.contextName=$routeParams.context_slug;
$scope.list_params.context=$scope.activeContext}else{$scope.activeContext=null}$scope.show_list=true;function getDataFromUrl(){$scope.parentId=$location.search().parent;todo_states=$location.search().todo_state;if(todo_states){if(!Array.isArray(todo_states)){todo_states=[todo_states]}todo_states=todo_states.map(function(v){return parseInt(v,10)})}else{todo_states=[2]}$scope.cachedStates=todo_states.slice(0);$scope.activeStates=todo_states.slice(0);$scope.list_params.todo_state=$scope.activeStates}getDataFromUrl();$scope.$on("$routeUpdate",getDataFromUrl);$scope.$on("filter-parent",function(callingScope,newParentId){$scope.parentId=newParentId;update_url($scope)});$scope.$watch("parentId",function(newParentId){if(newParentId){$scope.activeParent=Heading.get({id:newParentId});$scope.activeParent.$promise.then($scope.setVisibleHeadings)}else{$scope.activeParent=null;$scope.setVisibleHeadings()}});$scope.currentDate=new Date;$scope.$watch("currentDate",function(){$scope.$emit("refresh_list")},true);$scope.setVisibleHeadings=function(){var currentListFilter=$filter("currentList");$scope.visibleHeadings=[];if($scope.upcomingList){$scope.visibleHeadings=$scope.visibleHeadings.concat($scope.upcomingList);$scope.visibleHeadings=$scope.visibleHeadings.concat(currentListFilter($scope.actionsList,$scope.activeStates,$scope.upcomingList,$scope.activeParent))}};$scope.$watchCollection("actionsList",function(){$scope.setVisibleHeadings()});$scope.$watchCollection("upcomingList",function(){$scope.setVisibleHeadings()});$scope.refreshList=function(){var upcomingParams,$unwatch;$scope.isLoading=true;owWaitIndicator.start_wait("quick","loadLists");$scope.completedRequests=[];$scope.actionsList=Heading.query($scope.list_params);upcomingParams=angular.extend({upcoming:$scope.currentDate.ow_date()},$scope.list_params);$scope.upcomingList=Heading.query(upcomingParams);$scope.scheduledList=Heading.query({field_group:"actions_list",scheduled_date__lte:$scope.currentDate.ow_date(),todo_state:8});$unwatch=$scope.$watch(function(){return $scope.actionsList.$resolved&&$scope.upcomingList.$resolved&&$scope.scheduledList.$resolved},function(loadingIsComplete){$scope.isLoading=!loadingIsComplete;if(loadingIsComplete){owWaitIndicator.end_wait("quick","loadLists");$unwatch()}})};$scope.$on("refresh_list",$scope.refreshList);$scope.$on("refresh-data",$scope.refreshList);$scope.$on("focus-area-changed",function(e,newFocusArea){$scope.activeFocusArea=newFocusArea});$scope.toggleTodoState=function(targetState){var i=$scope.activeStates.indexOf(targetState.id);if(i>-1){$scope.activeStates.splice(i,1)}else{$scope.activeStates.push(targetState.id)}update_url($scope)};$scope.$watchCollection("activeStates",function(newList,oldList){var new_states,list_params;list_params={};list_params.todo_state=newList.filter(function(state){return $scope.cachedStates.indexOf(state)===-1});if(list_params.todo_state.length>0){new_states=Heading.query(list_params);new_states.$promise.then(function(){$scope.cachedStates=$scope.cachedStates.concat(list_params.todo_state);$scope.actionsList=$scope.actionsList.concat(new_states)})}$scope.setVisibleHeadings()});update_url=function(params){var path,search;path="/gtd/actions";if(params.activeContext){path+="/"+params.activeContext;path+="/"+params.contextName.toLowerCase().replace(/ /g,"-").replace(/[^\w\-]+/g,"")}$location.path(path);search={};if($scope.parentId){search.parent=$scope.parentId}search.todo_state=$scope.activeStates;$location.search(search)};$scope.changeContext=function(){var $navButton,$navText,$navLink,newContext;$scope.list_params.context=$scope.activeContext||0;if($scope.activeContext){$scope.contextName=$scope.contexts.filter(function(context){return context.id===$scope.activeContext})[0].name}else{delete $scope.contextName}$scope.list_params.todo_state=$scope.activeStates;$scope.$emit("refresh_list");update_url($scope);$cookies.activeContext=String($scope.activeContext);$navButton=$("#nav-actions");$navText=$navButton.find(".nav-text");$navLink=$navButton.find("a");newContext=$scope.contexts.filter(function(context){return context.id===$scope.activeContext});if(newContext.length===1){$navText.text(newContext[0].name+" Actions")}else{$navText.text("Next Actions")}$navLink.attr("href",$location.absUrl())}}]).controller("search",["$scope","$location","Heading",function($scope,$location,Heading){var i,query,resultIds,result,reString,addToResults;$scope.rawResults=[];$scope.queryString=$location.search().q.replace("+"," ");$scope.queries=$scope.queryString.split(" ");addToResults=function(r){$scope.rawResults=$scope.results.concat(r)};for(i=0;i<$scope.queries.length;i+=1){query=$scope.queries[i];Heading.query({title__contains:query}).$promise.then(addToResults);Heading.query({text__contains:query}).$promise.then(addToResults)}$scope.$watchCollection("rawResults",function(){resultIds=[];$scope.results=[];for(i=0;i<$scope.rawResults.length;i+=1){result=$scope.rawResults[i];if(resultIds.indexOf(result.id)===-1){$scope.results.push(result);resultIds.push(result.id)}}});reString="";for(i=0;i<$scope.queries.length;i+=1){reString+="|"+$scope.queries[i]}if($scope.queries.length>0){reString=reString.slice(1)}$scope.reString=reString}]).controller("calendar",["$scope","Heading","$filter","$modal",function($scope,Heading,$filter,$modal){var date,d,m,y;$scope.activeCalendars=[];date=new Date;d=date.getDate();m=date.getMonth();y=date.getFullYear();$scope.toggleCalendar=function(cal){var idx;idx=$scope.activeCalendars.indexOf(cal.calId);if(idx>-1){$scope.activeCalendars.splice(idx,1)}else{$scope.activeCalendars.push(cal.calId)}$scope.owCalendar.fullCalendar("render")};$scope.allCalendars=[];$scope.refreshCalendars=function(){var hardCalendar,dfrdCalendar,upcomingCalendar;hardCalendar={calId:1,order:10,name:"Scheduled tasks [HARD]",color:"rgb(92, 0, 92)",textColor:"white",field_group:"calendar",events:Heading.query({field_group:"calendar",todo_state__abbreviation:"HARD",archived:false})};dfrdCalendar={calId:2,order:20,name:"Reminders [DFRD]",color:"rgb(230, 138, 0)",textColor:"white",field_group:"calendar",events:Heading.query({field_group:"calendar",todo_state__abbreviation:"DFRD",archived:false})};upcomingCalendar={calId:3,order:30,name:"Deadlines",color:"rgb(204, 0, 0)",textColor:"white",field_group:"calendar_deadlines",events:Heading.query({field_group:"calendar_deadlines",deadline_date__gt:"1970-01-01",archived:false})};$scope.allCalendars.length=0;$scope.allCalendars.push(hardCalendar);$scope.allCalendars.push(dfrdCalendar);$scope.allCalendars.push(upcomingCalendar)};$scope.$on("refresh-data",$scope.refreshCalendars);$scope.refreshCalendars();$scope.editEvent=function(obj){var newScope,$off,modal;newScope=$scope.$new(true);newScope.editableEvent=obj;modal=$modal.open({scope:newScope,templateUrl:"edit-modal",windowClass:"calendar-edit"});$off=$scope.$on("finishEdit",function(e,newHeading){obj.$get();modal.close();$off()})};$scope.moveEvent=function(obj,dayDelta,minuteDelta){var newData,timeString,dateString,dateField,timeField;if(obj.field_group==="calendar_deadlines"){dateField="deadline_date";timeField="deadline_time"}else{dateField="scheduled_date";timeField="scheduled_time"}newData={id:obj.id};dateString=obj.start.getFullYear()+"-"+(obj.start.getMonth()+1)+"-"+obj.start.getDate();newData[dateField]=dateString;if(!obj.allDay){timeString=obj.start.getHours()+":"+obj.start.getMinutes();newData.scheduled_time=timeString}Heading.update(newData)};$scope.renderEvent=function(event,element){if($scope.activeFocusArea&&$scope.activeFocusArea.id>0){if(event.focus_areas.indexOf($scope.activeFocusArea.id)===-1){return false}}if(event.repeats){element.find(".fc-event-title").append('<span class="repeat-icon"></span>')}if($scope.activeCalendars.indexOf(event.calId)===-1){return false}};$scope.resizeEvent=function(event){var newData,dateString,timeString;if(event.field_group==="calendar"){newData={id:event.id};dateString=event.end.getFullYear()+"-"+(event.end.getMonth()+1)+"-"+event.end.getDate();newData.end_date=dateString;if(!event.allDay){timeString=event.end.getHours()+":"+event.end.getMinutes();newData.end_time=timeString}Heading.update(newData)}};$scope.$on("focus-area-changed",function(e,newFocusArea){var i,newList;$scope.activeFocusArea=newFocusArea;$scope.owCalendar.fullCalendar("rerenderEvents")});$scope.calendarOptions={editable:true,header:{left:"month agendaWeek agendaDay",center:"title",right:"today prev,next"},eventClick:$scope.editEvent,eventDrop:$scope.moveEvent,eventResize:$scope.resizeEvent,eventRender:$scope.renderEvent}}]);"use strict";var Message;Message=function(obj){if(obj===undefined){obj={}}this.fields={};this.set_fields(obj)};Message.prototype.set_fields=function(obj){$.extend(this.fields,obj);this.pk=obj.id;this.url="/wolfmail/message/"+this.pk+"/"};Message.prototype.create_node=function(obj){var that,success,data,scope;that=this;data={action:"create_node"};$.extend(data,obj);delete data.$scope;jQuery.ajax(this.url,{type:"PUT",data:data,success:function(){obj.$scope.$apply(obj.$scope.success(that))}})};Message.prototype.delete_msg=function(obj){var success,that;that=this;jQuery.ajax(this.url,{type:"DELETE",data:{action:"delete"},success:function(){obj.$scope.$apply(obj.$scope.success(that))}})};Message.prototype.archive=function(obj){var success,that;that=this;jQuery.ajax(this.url,{type:"PUT",data:{action:"archive"},success:function(){obj.$scope.$apply(obj.$scope.success(that))}})};Message.prototype.defer=function(obj){var success,that;that=this;jQuery.ajax(this.url,{type:"PUT",data:{action:"defer",target_date:obj.target_date},success:function(){obj.$scope.$apply(obj.$scope.success(that))}})};"use strict";angular.module("owServices").factory("Message",["$resource","$rootScope",function($resource,$rootScope){var res=$resource("/wolfmail/message/:id",{id:"@id"},{archive:{method:"PUT",params:{action:"archive"},transformResponse:function(data){data=angular.fromJson(data);$rootScope.$broadcast("message-archived",data.message);return data.message}},createNode:{method:"POST",params:{action:"create_heading"},transformResponse:function(data){data=angular.fromJson(data);$rootScope.$broadcast("heading-created",data.message,data.heading);return data.message}},defer:{method:"PUT",params:{action:"defer"},transformResponse:function(data){data=angular.fromJson(data);$rootScope.$broadcast("message-deferred",data.message);return data.message}}});return res}]);"use strict";angular.module("owDirectives").directive("owMessageRow",function(){function link(scope,element,attrs){var $element,$bTask,$bProject,$bComplete,$bDefer,$bArchive,$bDelete;$element=$(element);$element.find(".glyphicon").tooltip();scope.headings=[];$bTask=$element.find(".msg-task");$bProject=$element.find(".msg-project");$bComplete=$element.find(".msg-complete");$bDefer=$element.find(".msg-defer");$bArchive=$element.find(".msg-archive");$bDelete=$element.find(".msg-delete");if(attrs.owHandler==="plugins.deferred"){$bProject.remove();$bArchive.remove();$bDelete.remove()}else{$bComplete.remove()}scope.$on("heading-created",function(e,message,newHeading){if(scope.message.id===message.id){scope.headings.push(newHeading)}})}return{scope:true,link:link}}).directive("owMessageHeading",["todoStates",function(todoStates){function link(scope,element,attrs){scope.isEditable=false;scope.$on("finishEdit",function(){scope.isEditable=false});scope.$watch("heading.todo_state",function(newStateId){if(newStateId){scope.todoState=todoStates.filter(function(state){return state.id===newStateId})[0]}else{scope.todoState=null}})}return{scope:false,link:link}}]).directive("owMsgActions",["Heading",function(Heading){function link(scope,element,attrs){var $element,MessageApi;$element=$(element);scope.$task_modal=$element.find(".modal.task");scope.$delete_modal=$element.find(".modal.delete");scope.$defer_modal=$element.find(".modal.defer");if(scope.new_node===undefined){scope.new_node={}}scope.create_task_modal=function(msg){scope.new_node.title=msg.subject;if(msg.handler_path==="plugins.deferred"){msg.$createNode()}else{scope.active_msg=msg;scope.modal_task=true;scope.$task_modal.modal()}};scope.open_task_modal=function(msg){scope.new_node.close=false;scope.create_task_modal(msg)};scope.completeTask=function(msg){msg.$createNode({close:true})};scope.create_project_modal=function(msg){delete scope.new_node.tree_id;delete scope.new_node.parent;scope.new_node.title=msg.subject;scope.active_msg=msg;scope.modal_task=false;scope.$task_modal.modal()};scope.defer_modal=function(msg){var today;today=new Date;scope.active_msg=msg;scope.$defer_modal.modal()};scope.delete_modal=function(msg){scope.active_msg=msg;scope.$delete_modal.modal()};scope.archive=function(msg){msg.$archive()};scope.createNode=function(msg){scope.$task_modal.modal("hide").one("hidden.bs.modal",function(){msg.$createNode(scope.new_node)})};scope.change_project=function(project){scope.parents=Heading.query({tree_id:project.tree_id,archived:false});scope.parent=project};scope.change_parent=function(parent){scope.new_node.parent=parent.id};scope.deferMessage=function(){scope.new_node.target_date=scope.$defer_modal.find("#target-date").val();scope.$defer_modal.modal("hide").one("hidden.bs.modal",function(){scope.active_msg.$defer({target_date:scope.newDate})})};scope.delete_node=function(){scope.$delete_modal.modal("hide").one("hidden.bs.modal",function(){scope.active_msg.$delete().then(function(){scope.messages.splice(scope.messages.indexOf(scope.active_msg),1)})})}}return{link:link,scope:false,templateUrl:"/static/message-modals.html"}}]);"use strict";owFilters.filter("format_sender",["$sce",function($sce){return function(msg){var s;if(msg.handler_path==="plugins.deferred"){s="";s+='<span class="dfrd">DFRD</span> Node';s=$sce.trustAsHtml(s)}else if(msg.handler_path==="plugins.quickcapture"){s="Quick capture"}else{s=msg.sender}return s}}]);owFilters.filter("format_subject",["$sce",function($sce){return function(msg){var s;s="";if(msg.handler_path==="plugins.deferred"){s='<a href="/gtd/projects/#';s+=msg.source_node+"-";s+=msg.node_slug+'">';s+=msg.subject;s+="</a>";s=$sce.trustAsHtml(s)}else if(msg.handler_path==="plugins.quickcapture"){s=msg.subject}else{s='<a href="/wolfmail/inbox/'+msg.id+'/">';s+=msg.subject;s+="</a>"}return s}}]);owFilters.filter("format_date",function(){return function(date_str){var d;d=new Date(date_str);return d.toDateString()}});owFilters.filter("parent_label",function(){return function(parent){var s,i;s=parent.title;for(i=0;i<parent.level;i+=1){if(i===0){s=" "+s}s="---"+s}return s}});"use strict";var MessageFactory,owinbox,owmessage;angular.module("owMain").config(["$routeProvider","$locationProvider",function($routeProvider,$locationProvider){$locationProvider.html5Mode({enabled:true,requireBase:false});$routeProvider.when("/wolfmail/inbox/",{templateUrl:"/static/inbox.html",controller:"owInbox"}).when("/wolfmail/inbox/:msg_id/",{templateUrl:"/static/message.html",controller:"owMessage"})}]).controller("owInbox",["$scope","$rootScope","$resource","Message","Heading","owWaitIndicator","toaster",function($scope,$rootScope,$resource,Message,Heading,owWaitIndicator,toaster){var ds,today,get_messages;$scope.currentDate=new Date;$scope.$watch("currentDate",function(new_date,old_date){$scope.$emit("refresh_messages")},true);$scope.get_messages=function(e){owWaitIndicator.start_wait("quick","get-messages");$scope.messages=Message.query({in_inbox:true,rcvd_date__lte:$scope.currentDate.ow_date()});$scope.messages.$promise["finally"](function(){owWaitIndicator.end_wait("get-messages")});$scope.messages.$promise["catch"](function(){toaster.pop("error","Error getting messages.","Check your internet connection and try again")})};$rootScope.$on("refresh_messages",$scope.get_messages);$rootScope.$on("refresh-data",$scope.get_messages);$scope.$emit("refresh_messages");function removeMessage(message){var i=$scope.messages.map(function(msg){return msg.id}).indexOf(message.id);$scope.messages.splice(i,1)}$scope.$on("message-archived",function(e,message){removeMessage(message)});$scope.$on("message-deferred",function(e,message){removeMessage(message)});$scope.$on("heading-created",function(e,message){if(!message.in_inbox){removeMessage(message)}});$scope.projects=Heading.query({parent_id:0,archived:false});$scope.success=function(msg){$scope.messages.remove(msg)}}]).controller("owMessage",["$scope","$routeParams","$location","Message",function($scope,$routeParams,$location,Message){var msg,msg_id;msg_id=$routeParams.msg_id;$scope.msg=Message.get({id:msg_id});$scope.success=function(msg){$location.path("/wolfmail/inbox")}}]).directive("owFeedback",["$http","$timeout",function($http,$timeout){function link(scope,element,attrs){var $modal;$modal=element.find("#feedbackModal");scope.feedback={};scope.send_feedback=function(feedback){$http.post("/feedback/",{body:feedback.text}).success(function(){scope.success=true;$timeout(function(){scope.success=false;scope.feedback={};$modal.modal("hide")},1200)}).error(function(data,status,headers){console.log(data)})}}return{link:link,templateUrl:"/static/feedback-modal.html"}}]);"use strict";angular.module("owServices").factory("activeState",["$rootScope",function($rootScope){var activeState={user:null};$rootScope.$watch(function(){return activeState.user},function(newUser){if(newUser){$("body").removeClass("ow-logged-out");$("body").addClass("ow-logged-in")}else{$("body").addClass("ow-logged-out");$("body").removeClass("ow-logged-in")}});return activeState}]).factory("currentUser",["$resource","$rootScope",function($resource,$rootScope){var user=$resource("/user/current/").get();$rootScope.$on("refresh-data",function(){$resource("/user/current/").get().$promise.then(function(newUser){angular.extend(user,newUser)})});return user}]);"use strict";angular.module("owDirectives").directive("owNavbar",["$location","$cookies","contexts","currentUser",function($location,$cookies,contexts,currentUser){function link(scope,element,attrs){var regexps;scope.user=currentUser;regexps={actions:new RegExp("^/gtd/actions"),inbox:new RegExp("^/wolfmail/inbox/"),projects:new RegExp("^/gtd/projects/"),calendar:new RegExp("^/calendar/")};function setActiveLink(){var found,r,currPath,linkId;$("ul.navbar-nav li").removeClass("active");currPath=$location.path();for(linkId in regexps){if(regexps.hasOwnProperty(linkId)){r=regexps[linkId].exec(currPath);if(r){$("#nav-"+linkId).addClass("active")}}}}setActiveLink();scope.$on("$locationChangeSuccess",function(e){setActiveLink()});scope.$watch(function(){return $cookies.activeContext},function(newContext){newContext=parseInt(newContext,10);contexts.$promise.then(function(){scope.activeContext=contexts.filter(function(context){return context.id===newContext})[0]})})}return{scope:true,link:link}}]);"use strict";owFilters.value("staticUrl",null);owFilters.filter("static",["staticUrl",function(staticUrl){return function(filename){if(staticUrl!==null){filename=staticUrl+filename}return filename}}]);"use strict";angular.module("owMain").config(["$routeProvider",function($routeProvider){$routeProvider.when("/accounts/settings/",{templateUrl:"/static/settings.html",controller:"settings"})}]).controller("settings",["$scope","$window","$resource","$http","toaster",function($scope,$window,$resource,$http,toaster){var Provider,Account,isReadyToSave;Provider=$resource("/providers/");$scope.providers=Provider.query();Account=$resource("/accountassociations/:id/",{id:"@id"});$scope.$on("refresh-data",function(){$scope.linkedAccounts=Account.query()});$scope.linkedAccounts=Account.query();$scope.disconnectAccount=function(account){account.$delete().then(function(){toaster.pop("success","Deleted");$scope.$emit("refresh-data")})};$scope.addAccount=function(provider){var handlers,handler;handlers={Google:function(provider){isReadyToSave=true}};handler=handlers[provider.button_type];handler(provider)};$window.signInCallbacks=function(result){var data;if(isReadyToSave&&!result.error){data={access_token:result.access_token,code:result.code,handler_path:"plugins.google"};toaster.pop("info","Saving...");Account.save({},data).$promise.then(function(response){toaster.pop("success","Saved");$scope.$emit("refresh-data")},function(response){if(response.data.reason==="duplicate"){toaster.pop("error","Not saved","Duplicate Account")}else{toaster.pop("error","Not saved","An error occured. Please check your internet connection and try again.");console.log(response)}})}}}]);