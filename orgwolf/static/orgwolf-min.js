"use strict";var attach_pickers,validate_node,GtdHeading;validate_node=function(i){var b,j,e,a,h,f,c,g;b=/\S/;j=/\D/;e=true;a=function(d){d.find(".error").remove();d.find(".invalid").removeClass("invalid")};i.each(function(){var d=$(this);a(d);$(this).find("[data-validate]").each(function(){var k=$(this).attr("data-validate");if(k==="required"){if(!b.test($(this).attr("value"))){e=false;$(this).focus();$(this).addClass("invalid");$(this).after('<span class="error"><br />This field is required</span>')}}else{if(k==="date"){h=$(this).attr("value");if(b.test(h)){f=h.split("-");c=new Date(f[0],f[1]-1,f[2]);if(c.getFullYear()!==Number(f[0])||c.getMonth()+1!==Number(f[1])||c.getDate()!==Number(f[2])){$(this).addClass("invalid");$(this).after('<span class="error"><br />Please enter a valid date in the form YYYY-MM-DD</span>');e=false;$(this).focus()}}}else{if(k==="time"){h=$(this).attr("value");if(b.test(h)){f=h.split(":");g=new Date(0,0,0,f[0],f[1]);if(g.getHours()!==Number(f[0])||g.getMinutes()!==Number(f[1])){$(this).addClass("invalid");$(this).after('<span class="error"><br />Please enter a valid 24-hour time in the form HH:MM</span>');e=false;$(this).focus()}}}else{if(k==="int"){h=$(this).attr("value");if(b.test(h)&&j.test(h)){e=false;$(this).focus();$(this).addClass("invalid");$(this).after('<span class="error"><br />Please enter an integer</span>')}}}}}});$(this).find("[data-requires]").each(function(){var o,l,m,k,n;o=$(this);if(o.attr("checked")){l=$(this).attr("data-requires").split(",");for(m=0;m<l.length;m+=1){k=d.find(l[m]);n=k.attr("value");if(!b.test(n)){e=false;$(this).focus();k.addClass("invalid");k.parent().append('<span class="error"><br />Field required by '+o.attr("id")+"</span>")}}}})});return e};function repeating_toggle(b,a){if(a.find(b).attr("checked")==="checked"){a.find("#id_repeating_number").removeAttr("disabled");a.find("#id_repeating_unit").removeAttr("disabled");a.find("#id_repeats_from_completion").removeAttr("disabled")}else{a.find("#id_repeating_number").attr("disabled","disabled");a.find("#id_repeating_unit").attr("disabled","disabled");a.find("#id_repeats_from_completion").attr("disabled","disabled")}}attach_pickers=function(b){var c,a,d;if($.fn.datepicker){b.find("#id_repeats").click(function(){repeating_toggle("#id_repeats",b)});repeating_toggle("#id_repeats",b);b.find("input.datepicker").each(function(e){$(this).wrap('<div class="date datepicker input-append" data-date></div>');$(this).after('<span class="add-on">\n<i class="icon-calendar"></i>\n</span>');c=$(this).next("span.add-on").outerWidth();a=$(this).width()-c;$(this).width(a);$(this).removeClass("datepicker")});b.find(".datepicker").each(function(){$(this).datepicker({format:"yyyy-mm-dd"}).on("changeDate",function(){$(this).datepicker("hide")})});b.find("input.timepicker").each(function(e){$(this).wrap('<div class="bootstrap-timepicker-component input-append" data-date></div>');$(this).after('<span class="add-on">\n<i class="icon-time"></i>\n</span>');c=$(this).next("span.add-on").outerWidth();a=$(this).width()-c;$(this).width(a)});d=function(h){var g,e,f;g="#"+h;e="#id_"+$("#"+h).attr("toggles");f=e+" ~ span.add-on";if(b.find(g).attr("checked")==="checked"){b.find(e).removeAttr("disabled");b.find(f).removeClass("disabled")}else{b.find(e).attr("disabled","disabled");b.find(f).addClass("disabled")}};b.find("#id_scheduled_time_specific").click(function(){d($(this).attr("id"))});b.find("#id_deadline_time_specific").click(function(){d($(this).attr("id"))});d("id_scheduled_time_specific");d("id_deadline_time_specific");b.find("#id_scheduled_time").timepicker({defaultTime:"value",showMeridian:false});b.find("#id_deadline_time").timepicker({defaultTime:"value",showMeridian:false})}};$(document).ready(function(){attach_pickers($("body"));function a(c){var g,f,e,d;g=null;if(document.cookie&&document.cookie!==""){f=document.cookie.split(";");for(e=0;e<f.length;e+=1){d=jQuery.trim(f[e]);if(d.substring(0,c.length+1)===(c+"=")){g=decodeURIComponent(d.substring(c.length+1));break}}}return g}var b=a("csrftoken");$.ajaxSetup({beforeSend:function(c){c.setRequestHeader("X-CSRFToken",b)}})});(function(b){var a={init:function(c){return this.each(function(){var m,e,l,f,h,o,q,d,g,p,j,r,k,n;e=b(this);l=e.data("todoState");if(!l){e.find("a").contents().unwrap();f=e.attr("todo_id");h=b.extend({states:[{pk:0,display:"[None]"},],todo_id:f,node_id:0,click:function(){},parent_elem:e.parent()},c);o=function(u){var t,s;t={pk:-1,display:"",full:""};for(s=0;s<h.states.length;s+=1){if(h.states[s].pk===u){t=h.states[s]}}return t};h.get_todo_id=function(){var i;if(this.heading){i=this.heading.todo_id}else{i=this.todo_id}return Number(i)};q=o(f);d=function(){j.hide();e.unbind(".autohide")};g=function(){j.show();b("body").one("click.autohide",function(){d()});j.bind("click",function(i){i.stopPropagation()});e.bind("click.autohide",function(){d()})};e.tooltip({delay:{show:1000,hide:100},title:"click to change",placement:"right"});e.attr("data-original-title",q.full);p="";p+='<div class="popover right todostate">\n';p+='  <div class="arrow"></div>\n';p+='  <div class="popover-title">Todo State</div>\n';p+='  <div class="popover-inner">\n';p+="  </div>\n";p+="</div>\n";e.after(p);j=e.next(".popover");r=j.children(".popover-inner");j.hide();j.css("position","absolute");for(m=0;m<h.states.length;m+=1){k="";k+='<div class="todo-option"';k+=' todo_id="';k+=h.states[m].pk;k+='"';if(h.states[m].pk===h.get_todo_id()){k+=" selected"}k+=">";k+=h.states[m].display;k+="</div>\n";r.append(k)}e.bind("click",function(v){var s,u,i,t,w;v.stopPropagation();b(".popover.todostate").hide();e=b(this);e.tooltip("hide");s=e.position().left+e.width();j.css("left",s+"px");u=e.position().top;i=e.height();t=u+(i/2);w=t-(j.height()/2);j.css("top",w+"px");g()});n=r.children(".todo-option");n.mouseenter(function(){if(!b(this).attr("selected")){b(this).addClass("ow-hover")}});n.mouseleave(function(){b(this).removeClass("ow-hover")});n.bind("click",function(){var i,t,v,s,u;i=Number(b(this).attr("todo_id"));t=b(this).parent().parent();v=t.parent().parent().data("nodeOutline");s="/gtd/node/"+h.node_id+"/edit/";u={format:"json",todo_id:i,};if(i!==h.get_todo_id()){b.post(s,u,function(x){var A,w,y,z;x=b.parseJSON(x);if(x.status==="success"){if(h.heading){A=h.heading;w=A.todo_id;A.todo_id=x.todo_id}else{w=e.attr("todo_id");e.attr("todo_id",x.todo_id);f=x.todo_id;h.todo_id=x.todo_id}y=o(x.todo_id);e.html(y.display);e.attr("data-original-title",y.full);n.removeAttr("selected");z='.todo-option[todo_id="';z+=x.todo_id+'"]';r.children(z).attr("selected","");h.click(x);e.mouseenter();e.mouseleave()}});d()}});e.data("todoState",h)}})},update:function(c){this.each(function(){var i,h,g,e,d,f;i=b(this);h=i.data("todoState");g=i.next(".popover");if(typeof c.todo_id!=="undefined"){h.todo_id=c.todo_id;i.attr("todo_id",c.todo_id);e=".todo-option";d=e+'[todo_id="'+c.todo_id+'"]';g.find(e).removeAttr("selected");g.find(d).attr("selected","selected");f=h.states.filter(function(j){return j.pk===Number(c.todo_id)})[0];i.html(f.display);if(h.todo_id>0){i.show()}else{i.hide()}}i.data("todoState",h)})}};b.fn.todoState=function(d){var c;if(a[d]){c=a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){c=a.init.apply(this,arguments)}else{b.error("Method "+d+" does not exist on jQuery.todoState")}}return c}}(jQuery));(function(a){a.fn.alohaText=function(b){var c=this;if(typeof b!=="object"){b={}}b.$element=c;if(typeof b.$parent==="undefined"){b.$parent=b.$element.parent()}Aloha.ready(function(){var d=Aloha.jQuery(c);d.aloha()});c.data("alohaText",b);return this};a("document").ready(function(){Aloha.ready(function(){console.log("# Todo: Switch Aloha editor to PubSub");Aloha.bind("aloha-editable-deactivated",function(g,j){var d,h,k,f,b,c,i;d=j.editable;if(d.snapshotContent!==d.obj.html()){h=a(d.obj.context);k=h.data("alohaText");if(k){f=k.$parent;b="/gtd/node/"+f.attr("node_id")+"/edit/";c=h.html();if(c==="<br>"){c=""}i={format:"json",node_id:f.attr("node_id"),text:c};a.post(b,i,function(l){var e;l=a.parseJSON(l);if(k.heading){e=k.heading.$buttons.find("#edit-modal")}else{e=f.data("nodeOutline").$buttons.find("#edit-modal")}if(e.length>0){e.each(function(){var n,m;n=a(this).find("#id_text");m=n.siblings("#id_text-aloha");n.html(l.text);m.html(l.text)})}})}}})})})}(jQuery));(function(a){a.fn.nodeList=function(b){this.find(".list-node").each(function(){var e,d,c;e=a(this).attr("node_id");d=a(this).find(".todo-state");c=d.attr("todo_id");if(c===""){d.attr("todo_id",0);d.html('<span class="todo-none">[None]</span>\n')}d.todoState({states:b.states,node_id:e})});return this}}(jQuery));GtdHeading=function(a){if(!a){a={}}GtdHeading.ICON="icon-chevron-right";this.pk=0;this.populated=false;this.text="";this.todo_id=0;this.archived=false;this.level=1;this.scope=[];this.related_projects=[];var b=$("body");b.append('<i id="7783452" class="'+GtdHeading.ICON+'"></i>');this.icon_width=Number(b.find("#7783452").css("width").slice(0,-2));$("#7783452").remove();this.set_fields(a)};GtdHeading.prototype.set_fields=function(a){var b;if(typeof a.title_html==="undefined"){a.title_html=a.title}if(typeof a.pk!=="undefined"){a.pk=Number(a.pk)}if(typeof a.is_leaf_node!=="undefined"){a.has_children=!a.is_leaf_node;delete a.is_leaf_node}if(typeof a.todo_state!=="undefined"){a.todo_id=a.todo_state;delete a.todo_state}if(typeof a.previous_sibling_id!=="undefined"){a.previous_sibling=a.previous_sibling_id;delete a.previous_sibling_id}for(b in a){if(a.hasOwnProperty(b)){this[b]=a[b]}}return true};GtdHeading.prototype.get_todo_state=function(){var d,b,c,a;d=null;if(typeof this.workspace!=="undefined"){for(b=0;b<this.workspace.todo_states.length;b+=1){c=this.workspace.todo_states[b];if(c.pk===Number(this.todo_id)){d=c}}}if(d){a=d}else{a={pk:this.todo_id}}return a};GtdHeading.prototype.set_selectors=function(){if(this.level>0){var a=".heading";a+='[node_id="'+this.pk+'"]';this.$element=this.workspace.$children.find(a);this.$hoverable=this.$element.children(".ow-hoverable");this.$details=this.$element.children(".details");this.$children=this.$details.children(".children");this.$loading=this.$details.children(".loading");this.$clickable=this.$hoverable.children(".clickable");this.$todo_state=this.$hoverable.children(".todo-state");this.$icon=this.$hoverable.children("i");this.$text=this.$details.children(".ow-text");this.$buttons=this.$hoverable.children(".ow-buttons");this.$title=this.$hoverable.children(".ow-title")}};GtdHeading.prototype.as_html=function(){var a="";a+='<div class="heading" node_id="'+this.pk+'">\n';a+='  <div class="ow-hoverable">\n';a+='    <i class="twisty clickable '+GtdHeading.ICON+'"></i>\n';a+='    <span class="todo-state update" data-field="todo_abbr"></span>\n';a+='    <div class="clickable ow-title"></div>\n';a+='    <div class="ow-buttons">\n';a+='      <i class="icon-pencil edit-btn" title="Edit"></i>\n';a+='      <i class="icon-arrow-right detail-btn" title="Detail view"></i>\n';a+='      <i class="icon-plus new-btn" title="New subheading"></i>\n';a+="    </div>\n";a+="  </div>\n";a+='  <div class="details">\n';a+='    <div class="ow-text"></div>\n';a+='    <div class="children">\n';a+="    </div>\n";if(this.has_children){a+='    <div class="loading">\n';a+="      <em>Loading...</em>\n";a+="    </div>\n"}a+="  </div>\n</div>\n";return a};GtdHeading.prototype.create_div=function(b){var k,d,e,l,f,i,c,h,j,g,a;k=this;if(typeof this.$element==="undefined"){d=true}else{this.set_selectors();if(this.$element.length<1){d=true}else{if(this.$element.length>1){this.$element.each(function(){$(this).remove()});d=true}else{d=false}}}if(d&&(this.level>0)){e=this.pk;if(b){l=function(m){b.append(m)}}else{f=this.get_previous_sibling();i=this.pk;if(f){f.create_div();l=function(m){f.$element.after(m)}}else{if(this.workspace.get_heading(this.parent_id)){c=this.workspace;h=this.parent_id;b=c.get_heading(h).$children;l=function(m){b.prepend(m)}}else{return 1}}}l(this.as_html());this.set_selectors();this.state="closed";this.$details.hide();this.$buttons.children("i").tooltip({delay:{show:1000,hide:100}});j=this.workspace.COLORS;g=this.level%j.length;this.color=j[g-1];this.$clickable.css("color",this.color);this.set_indent(this.$children,1);this.set_indent(this.$loading,1);this.set_indent(this.$text,1);k=this;this.$clickable.click(function(){k.toggle()});this.$buttons.find(".icon-arrow-right").click(function(){window.location="/gtd/node/"+e+"/"});this.$buttons.find(".edit-btn").click(function(){var o,m,n;o=$(this);m=o.parent().parent();n=m.parent();m.unbind(".autohide");o.nodeEdit({$modal:k.workspace.$edit_modal,heading:k,show:true,target:m,node_id:e,changed:function(q){m.find(".todo-state").todoState("update",{todo_id:q.todo_state});k.text=q.text;k.archived=q.archived;k.title=q.title;var p=k.get_parent();if(p){p.redraw()}else{k.redraw()}},})});this.$buttons.find(".new-btn").click(function(){var m;m=$(this);m.parent().parent().unbind(".autohide");m.nodeEdit({show:true,parent:k,$modal:k.workspace.$edit_modal,changed:function(o){var p,n;o.workspace=k.workspace;p=new GtdHeading(o);k.workspace.headings.add(p);n=p.get_parent();n.has_children=true;n.redraw();n.open()},})});a=this.todo_states;return 1}};GtdHeading.prototype.get_previous_sibling=function(){return this.workspace.headings.get({pk:Number(this.previous_sibling)})};GtdHeading.prototype.get_parent=function(){return this.workspace.headings.get({pk:this.parent_id})};GtdHeading.prototype.get_children=function(){return this.workspace.headings.filter({parent_id:this.pk})};GtdHeading.prototype.is_expandable=function(){var b,c,a;b=false;if(this.level===0){b=true}if(this.text){b=true}else{if(this.workspace.show_all){if(this.workspace.scope){b=this.get_children().filter({scope:this.workspace.scope}).length}else{b=this.has_children}}else{c=this.get_children();if(this.workspace.scope){c=c.filter({scope:this.workspace.scope})}if(c.filter({archived:false}).length){b=true}else{if(this.populated===false&&this.has_children){b=true}}}}if(b){a=true}else{a=false}return a};GtdHeading.prototype.has_scope=function(b){var a;if(b===0){a=true}else{if((b===-1)&&(this.scope.length===0)){a=true}else{if(jQuery.inArray(b,this.scope)>-1){a=true}else{a=false}}}return a};GtdHeading.prototype.redraw=function(){var a,d,c,b;this.set_selectors();this.create_div();if(this.level>0){this.$element.addClass("hidden")}if(this.text){this.$element.addClass("expandable");this.$element.removeClass("lazy-expandable");this.$element.removeClass("arch-expandable")}else{if(this.workspace.show_all&&this.has_children){this.$element.addClass("expandable");this.$element.removeClass("lazy-expandable");this.$element.removeClass("arch-expandable")}else{if(this.populated&&this.has_children){if(this.is_expandable()){this.$element.addClass("expandable");this.$element.removeClass("lazy-expandable");this.$element.removeClass("arch-expandable")}else{this.$element.addClass("arch-expandable");this.$element.removeClass("expandable");this.$element.removeClass("lazy-expandable")}}else{if(this.has_children){this.$element.addClass("lazy-expandable");this.$element.removeClass("expandable");this.$element.removeClass("arch-expandable")}else{this.$element.removeClass("lazy-expandable");this.$element.removeClass("expandable");this.$element.removeClass("arch-expandable")}}}}if(this.has_scope(this.workspace.scope)){this.$element.removeClass("hidden")}if(this.state==="open"&&this.is_expandable()){this.$element.addClass("open")}else{this.$element.removeClass("open")}if(this.workspace.show_all){this.$element.removeClass("archived");this.$element.slideDown(this.workspace.ANIM_SPEED)}else{if(this.archived){this.$element.addClass("archived");this.$element.slideUp(this.workspace.ANIM_SPEED)}else{this.$element.removeClass("archived");this.$element.slideDown(this.workspace.ANIM_SPEED)}}if(this.$todo_state){a=this.get_todo_state();if(a.pk>0){this.$todo_state.html(a.display)}else{this.$todo_state.html("")}d=this;this.$todo_state.todoState({states:this.workspace.todo_states,node_id:this.pk,heading:this,click:function(e){d.todo_id=e.todo_id}})}if(this.$title){this.$title.html(this.title_html)}if(this.$text&&this.text){this.$text.html(this.text);this.$text.alohaText({heading:this,$parent:this.$element})}if(this.populated){this.$element.addClass("populated")}c=this.workspace.headings.filter({parent_id:this.pk});for(b=0;b<c.length;b+=1){c[b].redraw()}};GtdHeading.prototype.set_indent=function(b,c){var a=(this.icon_width+4)*c;b.css("margin-left",a+"px")};GtdHeading.prototype.show_error=function(b){var a="";a+='<i class="icon-warning-sign"></i>\n';a+="Error! Please refresh your browser\n";b.html(a)};GtdHeading.prototype.populate_children=function(b){var a,c,d;if(typeof b==="undefined"){b={}}a="/gtd/node/"+this.pk+"/descendants/";c=this;d=function(e){var f={offset:e.offset};$.getJSON(a,f,function(h){var g,j,l,m,k;if(h.status==="success"){g=h.nodes;for(j=0;j<g.length;j+=1){l=g[j];l.workspace=c.workspace;m=new GtdHeading(l);k=m.get_parent();if(k||m.level===1){c.workspace.headings.add(m)}if(k){m.create_div();if((!k.populated)&&k.$details){if(e.offset===1){k.$loading.slideUp(k.workspace.ANIM_SPEED)}else{k.$loading.hide()}}k.populated=true}}c.redraw();if((e.offset===1)&&k){k.$children.slideDown(k.workspace.ANIM_SPEED)}}})};if(!this.populated){if(this.level>0){this.$children.hide()}d({offset:1})}if(!this.populated_level_2){d({offset:2});this.populated_level_2=true}};GtdHeading.prototype.open=function(){this.state="open";this.$details.slideDown(this.workspace.ANIM_SPEED);this.populate_children();this.redraw()};GtdHeading.prototype.close=function(){this.state="closed";this.$details.slideUp(this.workspace.ANIM_SPEED);this.redraw()};GtdHeading.prototype.toggle=function(a){if(this.state==="open"){this.close()}else{if(this.state==="closed"){this.open()}}};(function(b){var a={init:function(c){var d=function(){var e=[];e.get=function(f){return this.filter(f)[0]};e.filter=function(l){var f,h,j,k,g;f=new d();for(h=0;h<this.length;h+=1){j=this[h];if(j.level===0){k=false}else{k=true}for(g in l){if(l.hasOwnProperty(g)){if(j[g] instanceof Array){if(l[g] instanceof Array){if(!((b(j.scope).not([]).length===0&&b([]).not(j.scope).length===0)&&typeof j.scope!=="undefined")){k=false}}else{if(jQuery.inArray(l[g],j[g])<0){k=false}}}else{if(j[g]!==l[g]){k=false}}}}if(k){f.push(j)}}return f};e.order_by=function(i){var f,g,h;f=/^(-)?(\S*)$/.exec(i);g=this.slice(0);h=function(k,j){var n,m,l;n=Number(k[f[2]]);m=Number(j[f[2]]);if(n&&m){l=n-m}else{if(k<j){l=-1}else{if(k>j){l=1}else{l=0}}}return l};g.sort(h);if(f[1]==="-"){g.reverse()}return g};e.add=function(h){var f,g;g=this.get({pk:h.pk});if(g){h.populated=g.populated;for(f in h){if(h.hasOwnProperty(f)){g[f]=h[f]}}}else{this.push(h)}};return e};if(!c){c={}}if(c.get_proto){return GtdHeading}this.each(function(){var o,g,m,l,p,e,f,n,k,q,j;o=b(this);g=o.attr("data-node_id");if(g==="0"){m="Projects:"}else{m="Children:"}l={};p=["blue","brown","purple","red","green","teal","slateblue","darkred"];e=300;f=new GtdHeading({pk:g,title:"Outline Workspace",});f.$element=o;f.$element.addClass("heading");f.workspace=f;f.show_all=false;f.$element.data("nodeOutline",f);f.level=0;f.COLORS=p;f.ANIM_SPEED=e;f.state="open";f.color=f.COLORS[0];f.headings=new d();if(typeof c.todo_states!=="undefined"){f.todo_states=c.todo_states}else{f.todo_states={todo_id:0,display:"[None]"}}if(c.scopes){f.scopes=c.scopes}else{f.scopes={}}f.scopes.activate=function(h){f.scope=h;f.$scope_tabs.find("li.active").each(function(){b(this).removeClass("active")});f.$scope_tabs.find('li[pk="'+h+'"]').addClass("active");f.$children.fadeOut(f.ANIM_SPEED,function(){f.redraw()});f.$children.fadeIn(f.ANIM_SPEED)};f.scopes.get=function(i){var h;for(h in f.scopes){if(f.scopes.hasOwnProperty(h)){if(f.scopes[h].pk===i){return f.scopes[h]}}}};f.get_heading=function(r){var h;for(h=0;h<this.headings.length;h+=1){if(this.headings[h].pk===r){return this.headings[h]}}};f.headings.add(f);o.find(".ow-heading").each(function(){var u,t,h,w,x,v,z,i,s,r,y;u=b(this);t=u.attr("data-node_id");h=u.attr("data-todo_id");w=u.attr("data-title");x=u.attr("data-text");v=f.pk;z=u.attr("data-tag_string");i=u.attr("data-previous_sibling");if(u.attr("data-is_leaf_node")==="False"){s=true}else{s=false}if(i===""){i=undefined}else{i=Number(i)}r={pk:t,title:w,text:x,todo_state:h,parent_id:v,tags:z,level:1,previous_sibling_id:i,has_children:s,workspace:f};y=new GtdHeading(r);f.headings.add(y)});o.html("");n="";n+='<ul class="nav nav-tabs" id="scope-tabs">\n';n+='\t<li pk="0" class="pointer"><a>All</a></li>\n';for(k in f.scopes){if(f.scopes.hasOwnProperty(k)){q=f.scopes[k];if(q.model==="gtd.scope"){n+='\t<li pk="'+q.pk+'" class="pointer"><a>'+q.fields.display+"</a></li>\n"}}}n+='\t<li pk="-1" class="pointer"><a>None</a></li>\n';n+="</ul>";o.append(n);f.$scope_tabs=o.children("#scope-tabs");f.$scope_tabs.find("li").on("click.switch",function(i){var h=Number(b(this).attr("pk"));f.scopes.activate(h)});o.append("<strong>"+m+'</strong><br />\n<div class="children"></div>');f.$children=o.children(".children");j=f.headings.filter({level:1});f.redraw();f.scopes.activate(0);n="";n+='<div class="ow-buttons" id="add-heading">\n';n+='  <i class="icon-plus-sign"></i>Add Heading\n';n+="</div>\n";n+='<label class="checkbox" id="show-all-label">\n';n+='  <input class="ow-buttons show-all" type="checkbox">';n+="  </input>Show archived</label>\n";f.$children.append(n);f.$showall=o.find(".show-all");f.$showall.bind("change.show-all",function(h){if(f.show_all){f.show_all=false}else{f.show_all=true}f.redraw()});f.$add=o.find("#add-heading");b.get("/gtd/node/new/",{format:"modal_form"},function(h){f.$element.append(h);f.$edit_modal=f.$element.children("#new-modal");attach_pickers(f.$edit_modal);f.$add.on("click",function(r){var i=b(this);i.nodeEdit({show:true,$modal:f.$edit_modal,parent_id:f.pk,changed:function(s){var t;s.workspace=f;t=new GtdHeading(s);f.headings.add(t);f.redraw()}})})});f.populated_level_2=true;f.populate_children()})},};b.fn.nodeOutline=function(d){var c;if(a[d]){c=a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){c=a.init.apply(this,arguments)}else{b.error("Method "+d+" does not exist on jQuery.todoState")}}return c}}(jQuery));(function(a){a.fn.agenda=function(i){var j,f,h,c,g,b,e,d;j=this.find("form.date");f=j.find('input[name="date"][type="text"]');h=this;if(!this.data("agenda")){this.data("agenda",{})}c=a.extend(this.data("agenda"),i);g=function(n){var o,k,m,q,l,p;o=/(\d{4})-([01]?\d)-([0-3]?\d)/;k=o.exec(n);if(k){m=Number(k[1]);q=Number(k[2])-1;l=Number(k[3]);p=new Date(m,q,l)}else{p=undefined}return p};c.date=g(this.attr("date"));if(!c.date){b=new Date();e=new Date(b.getFullYear(),b.getMonth(),b.getDate());c.date=e}this.data("agenda",c);d=function(){var k="/gtd/agenda/"+c.date.getFullYear()+"-"+(c.date.getMonth()+1)+"-"+c.date.getDate()+"/";a.getJSON(k,{format:"json"},function(m){var n,l;if(m.status==="success"){h.find(".daily").html(m.daily_html);h.find(".timely").html(m.timely_html);h.find(".deadlines").html(m.deadlines_html);n="";l=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];n+=l[c.date.getMonth()]+". ";n+=c.date.getDate()+", ";n+=c.date.getFullYear();h.children(".date:header").html(n)}})};j.bind("submit",function(){var k=g(f.val());if(k){c.date=k;h.data("agenda",c);d()}else{jQuery.error("Improperly formatted date: "+f.val())}return false});h.find(".todo-state").each(function(){var k=a(this).parent().attr("node_id");a(this).todoState({states:c.states,node_id:k,click:function(){d()}})});return this}}(jQuery));(function(b){var a={init:function(k){var i,g,n,d,c,e,l,f,j,h,m;if(typeof k==="undefined"){k={}}i="";if(k.url){i=k.url}else{if(k.heading){i="/gtd/node/"+k.heading.pk+"/edit/"}else{if(k.node_id>0){i="/gtd/node/"+k.node_id+"/edit/"}else{if(k.parent_id>0){i="/gtd/node/"+k.parent_id+"/new/"}else{if(k.parent){i="/gtd/node/"+k.parent.pk+"/new/"}else{i="/gtd/node/new/"}}}}}g=this.data("nodeEdit");if(k.parent){if(g){g.parent=k.parent}k.parent_id=k.parent.pk}if(g){g.edit_url=i;g.$modal.find("#edit_url").attr("value",i)}else{g={edit_url:i};n=k.show;d=b(k.target);c=this;e=k.node_id;l=k.parent_id;f=k.changed;j=k.on_modal;g.changed=f;g.heading=k.heading;g.parent=k.parent;g.on_modal=k.on_modal;g.$target=d;h=function(){var z,A,y,p,t,q,v,w,r,x,u,o;if(g.heading){z=g.heading;g.$modal.find(".header-title").html('Edit "'+z.title_html+'"');g.$modal.find("#id_title").attr("value",z.title);g.$modal.find("#id_text").attr("value",z.text);g.$modal.find("#id_text-aloha").html(z.text);g.$modal.find("#id_tag_string").attr("value",z.tag_string);if(z.archived){g.$modal.find("#id_archived").attr("checked","checked")}g.$modal.find("#id_scheduled_date").attr("value",z.scheduled_date);g.$modal.find("#id_scheduled_time").attr("value",z.scheduled_time);if(z.scheduled_time_specific){g.$modal.find("#id_scheduled_time_specific").attr("checked","checked")}g.$modal.find("#id_deadline_date").attr("value",z.deadline_date);g.$modal.find("#id_deadline_time").attr("value",z.deadline_time);if(z.deadline_time_specific){g.$modal.find("#id_deadline_time_specific").attr("checked","checked")}g.$modal.find("#id_repeating_number").attr("value",z.repeating_number);if(z.repeats){g.$modal.find("#id_repeats").attr("checked","checked")}A='option[value="'+z.repeating_unit+'"]';g.$modal.find("#id_repeating_unit").find(A).attr("selected","selected");if(z.repeats_from_completion){g.$modal.find("#id_repeats_from_completion").attr("checked","checked")}repeating_toggle("#id_repeats",g.$modal);A='option[value="'+z.priority+'"]';g.$modal.find("#id_priority").find(A).attr("selected","selected");if(z.todo_id){g.$modal.find("#id_todo_state").children('option[value="'+z.todo_id+'"]').attr("selected","selected")}else{g.$modal.find("#id_todo_state").children('option[value="0"]').attr("selected","selected")}y=g.$modal.find("#id_scope");for(p=0;p<z.scope.length;p+=1){A='option[value="'+z.scope[p]+'"]';y.find(A).attr("selected","selected")}t=g.$modal.find("#id_related_projects");for(p=0;p<z.related_projects.length;p+=1){A='option[value="'+z.related_projects[p]+'"]';t.find(A).attr("selected","selected")}}else{q=["#id_title","#id_scheduled_date","#id_scheduled_time","#id_deadline_date","#id_deadline_time","#id_tag_string","#id_text","#id_repeating_number"];v=["#id_todo_state","#id_priority","#id_related_projects","#id_scope","#id_repeating_unit"];w=["#id_archived","#id_scheduled_time_specific","#id_deadline_time_specific","#id_repeats","#id_repeats_from_completion"];g.$modal.find(".header-title").html("New node");for(p=0;p<q.length;p+=1){g.$modal.find(q[p]).attr("value","")}r=function(){b(this).removeAttr("selected")};for(p=0;p<v.length;p+=1){g.$modal.find(v[p]).find("option:selected").each(r);g.$modal.find(v[p]).find('option[value=""]').attr("selected","selected")}if(g.parent){x=g.parent.scope;y=g.$modal.find("#id_scope");for(p=0;p<x.length;p+=1){y.find('option[value="'+x[p]+'"]').attr("selected","selected")}u=g.parent.related_projects;o=g.$modal.find("#id_related_projects");for(p=0;p<u.length;p+=1){o.find('option[value="'+u[p]+'"]').attr("selected","selected")}}for(p=0;p<w.length;p+=1){g.$modal.find(w[p]).removeAttr("checked")}g.$modal.find("#id_text-aloha").html('<br class="aloha-cleanme" style="">')}g.$modal.modal("toggle");g.$modal.find("#id_title").focus()};m=function(){var q,p,o,r;q=g.$modal.find("#id_text");p=Aloha.jQuery(q);p.aloha();g.$modal.modal({show:false});if(n){h()}c.click(function(s){s.preventDefault();h()});g.$modal.on("hidden",function(){a.reset({$elem:c})});g.$modal.on("show",function(){g.$modal.find(".modal-body").scrollTop(0)});g.$modal.on("shown",function(){g.$modal.find("#id_title").focus()});o=g.$modal.find("form");o.unbind("submit.submit_edit");o.on("submit.submit_edit",function(u){var t,v,s;if(!validate_node(b(this))){return false}u.preventDefault();t=o.serialize();t+="&format=json&auto_repeat=false";v=g.$modal.find("#edit_url").attr("value");if(v){s=v}else{s=g.edit_url}b(this).data("nodeEdit",g);r=this;b.post(s,t,function(x){var w,y;x=b.parseJSON(x);if(x.status==="success"){w=x.node_data;y=b(r).data("nodeEdit");if(w.todo_state===null){w.todo_state=0}y.todo_id=w.todo_state;if(y.heading){y.heading.set_fields(w)}if(d){d.find(".update").each(function(){var A,z;A=b(this).attr("data-field");z=w[A];b(this).html(z)})}y.$modal.modal("hide");if(typeof y.changed!=="undefined"){y.changed(w)}}else{console.log(x)}})});if(g.on_modal){g.on_modal(g.$modal)}};if(k.$modal){g.$modal=k.$modal;g.$modal.find("#edit_url").attr("value",g.edit_url);m()}else{b.get(g.edit_url,{format:"modal_form"},function(o){c.after(o);g.$modal=c.next(".modal");attach_pickers(g.$modal);var p=g.$modal.find("#id_todo_state").children('option[selected="selected"]');if(p.length===1){g.todo_id=Number(p.attr("value"))}else{g.todo_id=0}m()})}c.data("nodeEdit",g)}},update:function(e){var h,g,d,c,f;h=this;g=h.data("nodeEdit");if(g){d=g.$modal;if(typeof e.todo_id!=="undefined"){g.todo_id=e.todo_id;c=d.find("#id_todo_state");c.find("option").removeAttr("selected");f=c.find('option[value="'+e.todo_id+'"]');f.attr("selected","selected")}h.data("nodeEdit",g)}},reset:function(d){var c;if(typeof d==="undefined"){d={}}if(typeof d.$elem!=="undefined"){c=d.$elem}else{c=this}return c.each(function(){var i,h,e,g,f;i=b(this);h=i.data("nodeEdit");if(h){e=h.$modal;g=e.find("#id_todo_state");g.find("option").removeAttr("selected");f='option[value="'+h.todo_id+'"]';g.find(f).attr("selected","selected")}})}};b.fn.nodeEdit=function(d){var c;if(a[d]){c=a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){c=a.init.apply(this,arguments)}else{b.error("Method "+d+" does not exist on jQuery.nodeEdit")}}return c}}(jQuery));(function(b){var a={init:function(c){return this.each(function(){var f,e,d;if(typeof c==="undefined"){c={}}f=b(this);e={};e.node_id=f.attr("node_id");e.url="/gtd/node/"+e.node_id+"/edit/";e.sel="button";d=f.find(e.sel);d.bind("click.buttons",function(j){var g,i,h;j.preventDefault();g=b(this);i=g.attr("value");h={format:"json",todo_id:i};jQuery.post(e.url,h,function(k){k=b.parseJSON(k);if(k.status==="success"){a.update({todo_id:k.todo_id,$elem:f});if(typeof c.callback!=="undefined"){c.callback(k)}}})});f.data("todobuttons",e)})},update:function(d){var c;if(typeof d.$elem==="undefined"){c=this}else{c=d.$elem}return c.each(function(){var f,e,g;f=b(this);e=f.data("todobuttons");if(!e){a.init()}if(typeof d.todo_id!=="undefined"){e.todo_id=d.todo_id}b(e.sel).removeClass("active");g=e.sel+'[value="'+e.todo_id+'"]';f.find(g).addClass("active");f.data("todobuttons",e)})}};b.fn.todoButtons=function(d){var c;if(a[d]){c=a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){c=a.init.apply(this,arguments)}else{b.error("Method "+d+" does not exist on jQuery.todoButtons")}}return c}}(jQuery));