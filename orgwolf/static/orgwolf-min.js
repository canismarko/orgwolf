/*!
 * jQuery Cookie Plugin v1.3
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function(f,b,g){var a=/\+/g;function e(h){return h}function c(h){return decodeURIComponent(h.replace(a," "))}var d=f.cookie=function(p,o,u){if(o!==g){u=f.extend({},d.defaults,u);if(o===null){u.expires=-1}if(typeof u.expires==="number"){var q=u.expires,s=u.expires=new Date();s.setDate(s.getDate()+q)}o=d.json?JSON.stringify(o):String(o);return(b.cookie=[encodeURIComponent(p),"=",d.raw?o:encodeURIComponent(o),u.expires?"; expires="+u.expires.toUTCString():"",u.path?"; path="+u.path:"",u.domain?"; domain="+u.domain:"",u.secure?"; secure":""].join(""))}var h=d.raw?e:c;var r=b.cookie.split("; ");for(var n=0,k=r.length;n<k;n++){var m=r[n].split("=");if(h(m.shift())===p){var j=h(m.join("="));return d.json?JSON.parse(j):j}}return null};d.defaults={};f.removeCookie=function(i,h){if(f.cookie(i)!==null){f.cookie(i,null,h);return true}return false}})(jQuery,document);"use strict";var attach_pickers,validate_node,GtdHeading;function ow_waiting(f,g){var e,c,a,d,b;c=/(\w+)?\.?(\w+)?/;a=c.exec(f);d=a[1];b=a[2];e=$("body").data("ow-waiting");if(e===undefined){e={};$("body").prepend('<div id="loading"></div>');e.$loading=$("#loading");e.$loading.hide();e.$loading.append('<div id="mask"></div>');e.$mask=e.$loading.find("#mask");e.$mask.append('<div id="dark"></div>');e.$mask.append('<img id="spinner" alt="loading" src="/static/ajax-loader.gif"></img>');$("body").data("ow-waiting",e)}if(d==="clear"){e.$loading.fadeOut()}else{e.$mask.hide();e.$loading.show(g);if(d==="spinner"){e.$mask.fadeIn()}}}var persona_user;$(document).ready(function(){function a(c){var g,f,e,d;g=null;if(document.cookie&&document.cookie!==""){f=document.cookie.split(";");for(e=0;e<f.length;e+=1){d=jQuery.trim(f[e]);if(d.substring(0,c.length+1)===(c+"=")){g=decodeURIComponent(d.substring(c.length+1));break}}}return g}var b=a("csrftoken");$.ajaxSetup({beforeSend:function(c){c.setRequestHeader("X-CSRFToken",b)},dataType:"json",})});(function(a){a.fn.alohaText=function(b){var c=this;if(typeof b!=="object"){b={}}b.$element=c;if(typeof b.$parent==="undefined"){b.$parent=b.$element.parent()}Aloha.ready(function(){var d=Aloha.jQuery(c);d.aloha()});c.data("alohaText",b);return this};a("document").ready(function(){Aloha.ready(function(){console.log("# Todo: Switch Aloha editor to PubSub");Aloha.bind("aloha-editable-activated",function(g,c){var d,b,f;d=c.editable;f=a(d.obj.context);b=f.data("alohaText");if(b){b.old_text=d.snapshotContent}});Aloha.bind("aloha-editable-deactivated",function(g,j){var d,h,k,f,b,c,i;d=j.editable;h=a(d.obj.context);k=h.data("alohaText");if(k){if(k.old_text!==d.obj.html()){f=k.$parent;b="/gtd/node/"+f.attr("node_id")+"/";c=h.html();if(c==="<br>"){c=""}i={format:"json",node_id:f.attr("node_id"),text:c};a.post(b,i,function(m){var e=[],l;m=a.parseJSON(a.parseJSON(m))[0];if(k.heading){k.heading.set_fields(m)}else{l=f.data("nodeOutline");if(l){e=f.data("nodeOutline").$buttons.find("#edit-modal")}}})}}})})})}(jQuery));(function(a){a.fn.nodeList=function(b){this.find(".list-node").each(function(){var e,d,c;e=a(this).attr("node_id");d=a(this).find(".todo-state");c=d.attr("todo_id");if(c===""){d.attr("todo_id",0);d.html('<span class="todo-none">[None]</span>\n')}d.todoState({states:b.states,node_id:e})});return this}}(jQuery));(function(a){a.fn.agenda=function(j){var k,f,i,c,g,b,e,d,h;k=this.find("form.date");f=k.find('input[name="date"][type="text"]');i=this;if(!this.data("agenda")){this.data("agenda",{})}c=a.extend(this.data("agenda"),j);g=function(o){var p,l,n,r,m,q;p=/(\d{4})-([01]?\d)-([0-3]?\d)/;l=p.exec(o);if(l){n=Number(l[1]);r=Number(l[2])-1;m=Number(l[3]);q=new Date(n,r,m)}else{q=undefined}return q};c.date=g(this.attr("date"));if(!c.date){b=new Date();e=new Date(b.getFullYear(),b.getMonth(),b.getDate());c.date=e}this.data("agenda",c);d=function(){var l="/gtd/agenda/"+c.date.getFullYear()+"-"+(c.date.getMonth()+1)+"-"+c.date.getDate()+"/";a.getJSON(l,{format:"json"},function(n){var o,m;if(n.status==="success"){i.find(".daily").html(n.daily_html);i.find(".timely").html(n.timely_html);i.find(".deadlines").html(n.deadlines_html);o="";m=["Jan.","Feb.","Mar.","Apr.","May","Jun.","Jul.","Aug.","Sep.","Oct.","Nov.","Dec."];o+=m[c.date.getMonth()]+" ";o+=c.date.getDate()+", ";o+=c.date.getFullYear();i.children(".date:header").html(o);h()}})};k.bind("submit",function(){var l=g(f.val());if(l){c.date=l;i.data("agenda",c);d()}else{jQuery.error("Improperly formatted date: "+f.val())}return false});h=function(){i.find(".todo-state").each(function(){var l=a(this).parent().attr("node_id");a(this).todoState({states:c.states,node_id:l,click:function(){d()}})})};h();return this}}(jQuery));(function(b){var a={init:function(c){return this.each(function(){var m,e,l,f,h,o,q,d,g,p,j,r,k,n;e=b(this);l=e.data("todoState");if(!l){e.find("a").contents().unwrap();f=e.attr("todo_id");h=b.extend({states:[{pk:0,display:"[None]"},],todo_id:f,node_id:0,click:function(){},parent_elem:e.parent()},c);o=function(u){var t,s;t={pk:-1,display:"",full:""};for(s=0;s<h.states.length;s+=1){if(h.states[s].pk===u){t=h.states[s]}}return t};h.get_todo_id=function(){var i;if(this.heading){i=this.heading.todo_state}else{i=this.todo_id}return Number(i)};q=o(f);d=function(){j.hide();e.unbind(".autohide")};g=function(){j.show();b("body").one("click.autohide",function(){d()});j.bind("click",function(i){i.stopPropagation()});e.bind("click.autohide",function(){d()})};e.tooltip({delay:{show:1000,hide:100},title:"click to change",placement:"right"});e.attr("data-original-title",q.full);p="";p+='<div class="popover right todostate">\n';p+='  <div class="arrow"></div>\n';p+='  <div class="popover-title">Todo State</div>\n';p+='  <div class="popover-inner">\n';p+="  </div>\n";p+="</div>\n";e.after(p);j=e.next(".popover");r=j.children(".popover-inner");j.hide();j.css("position","absolute");for(m=0;m<h.states.length;m+=1){k="";k+='<div class="todo-option"';k+=' todo_id="';k+=h.states[m].pk;k+='"';if(h.states[m].pk===h.get_todo_id()){k+=" selected"}k+=">";k+=h.states[m].display;k+="</div>\n";r.append(k)}e.bind("click",function(v){var s,u,i,t,x,w;v.stopPropagation();b(".popover.todostate").hide();e=b(this);e.tooltip("hide");s=e.position().left+e.width();j.css("left",s+"px");u=e.position().top;i=e.height();t=u+(i/2);x=t-(j.height()/2);j.css("top",x+"px");if(h.heading){w=h.heading.todo_state;j.find(".todo-option").removeAttr("selected");j.find('.todo-option[todo_id="'+w+'"]').attr("selected","selected")}g()});n=r.children(".todo-option");n.mouseenter(function(){if(!b(this).attr("selected")){b(this).addClass("ow-hover")}});n.mouseleave(function(){b(this).removeClass("ow-hover")});n.bind("click",function(){var i,t,v,s,u;i=Number(b(this).attr("todo_id"));t=b(this).parent().parent();v=t.parent().parent().data("nodeOutline");s="/gtd/node/"+h.node_id+"/";u={fields:{todo_state:i,auto_update:true,},};u=JSON.stringify(u);if(i!==h.get_todo_id()){b.ajax(s,{data:u,type:"PUT",contentType:"application/json",success:function(x){var A,w,y,z;while(typeof x==="string"){x=b.parseJSON(x)}x=x[0];if(h.heading){h.heading.set_fields(x);h.heading.redraw()}else{w=e.attr("todo_id");e.attr("todo_id",x.fields.todo_state);f=x.fields.todo_state;h.todo_id=x.fields.todo_state}y=o(x.fields.todo_state);e.html(y.display);e.attr("data-original-title",y.full);n.removeAttr("selected");z='.todo-option[todo_id="';z+=x.todo_id+'"]';r.children(z).attr("selected","");if(x.fields.repeats){alert("Node scheduled for "+x.fields.scheduled.slice(0,10))}h.click(x);e.mouseenter();e.mouseleave()}});d()}});e.data("todoState",h)}})},update:function(c){this.each(function(){var i,h,g,e,d,f;i=b(this);h=i.data("todoState");g=i.next(".popover");if(typeof c.todo_state!=="undefined"){h.todo_state=c.todo_state;i.attr("todo_id",c.todo_state);e=".todo-option";d=e+'[todo_id="'+c.todo_state+'"]';g.find(e).removeAttr("selected");g.find(d).attr("selected","selected");f=h.states.filter(function(j){return j.pk===Number(c.todo_state)})[0];i.html(f.display);if(h.todo_state>0){i.show()}else{i.hide()}}i.data("todoState",h)})}};b.fn.todoState=function(d){var c;if(a[d]){c=a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){c=a.init.apply(this,arguments)}else{b.error("Method "+d+" does not exist on jQuery.todoState")}}return c}}(jQuery));"use strict";var GtdHeading,HeadingManager;GtdHeading=function(b){var c,d,a;if(!b){b={}}this.fields={archived:false,priority:"B",scope:[],text:"",title:"",todo_state:null,tree_id:null,};this.pk=0;this.workspace={};this.archived=false;this.populated=false;this.expandable="lazy";this.rank=1;this.state="closed";this.visible=false;this.children=new HeadingManager(b.workspace);this.set_fields(b);this.parent_obj=this.get_parent();if(this.workspace){if(this.parent_obj){this.rank=this.parent_obj.rank+1}}};GtdHeading.prototype.set_fields=function(f){var g,h,e,c,b;b=$.extend({},f);e=/^\d{4}-\d{2}-\d{2}[0-9:TZ]*/;if(b.id!==undefined){this.pk=Number(b.id);delete b.id}if(b.workspace!==undefined){this.workspace=b.workspace;delete b.workspace}this.model=b.model;delete b.model;try{if(b.parent===this.pk){throw"bad parent"}}catch(a){if(a==="bad parent"){console.error("Cannot create node as a child of itself");throw a}}jQuery.extend(this.fields,b);this.update()};GtdHeading.prototype.get_todo_state=function(){var d,b,c,a;d=null;if(typeof this.workspace!=="undefined"){for(b=0;b<this.workspace.todo_states.length;b+=1){c=this.workspace.todo_states[b];if(c.pk===Number(this.todo_state)){d=c}}}if(d){a=d}else{a={pk:this.todo_state}}return a};GtdHeading.prototype.get_title=function(){var a;a=this.title;if(this.archived){a='<span class="archived-text">'+a+"</span>"}return a};GtdHeading.prototype.get_previous_sibling=function(){var b,c,a;b=null;if(this.level===0){c=this.fields.tree_id;while(c>1&&b===null){c=c-1;b=this.workspace.headings.get({tree_id:c,level:0,})}}else{a=this.fields.lft;a=a-2;while(a>1&&b===null){b=this.workspace.headings.get({tree_id:this.fields.tree_id,parent:this.fields.parent,lft:a,})}}return b};GtdHeading.prototype.get_parent=function(){var a;if(this.rank>0&&this.workspace.headings){if(this.fields.parent===null){a=this.workspace}else{a=this.workspace.headings.get({pk:this.fields.parent})}}else{a=null}return a};GtdHeading.prototype.get_children=function(){var a;if(this.rank===0){a=this.workspace.headings.filter_by({rank:1})}else{a=this.workspace.headings.filter_by({parent:this.pk}).order_by("lft")}return a};GtdHeading.prototype.refresh_tree=function(){var a,b,c,d;a="/gtd/tree/"+this.fields.tree_id+"/";c=this;$.get(a,function(e){while(typeof e==="string"){e=$.parseJSON(e)}for(b=0;b<e.length;b+=1){d=new GtdHeading(e[b]);c.workspace.headings.add(d)}})};GtdHeading.prototype.is_leaf_node=function(){var a;if(this.fields.rght-this.fields.lft===1){a=true}else{if(this.fields.rght-this.fields.lft>1){a=false}else{a=undefined}}return a};GtdHeading.prototype.is_expandable=function(){var b,a,c;b=undefined;c=/\S+/;if(c.test(this.fields.text)||c.test(this.fields.tag_string)||this.fields.scheduled_date||this.fields.deadline_date){b=true}else{if(this.populated){if(this.children.length>0){b=true}else{b=false}}}return b};GtdHeading.prototype.is_visible=function(i){var b,d,j,e,f,c,k,g,h,a;b=true;if(this.workspace.active_scope){if(this.pk===22){console.log(this.workspace.active_scope)}if(this.fields.scope.indexOf(this.workspace.active_scope)===-1){b=false}}j=this.workspace.active_states;if(typeof j!=="undefined"){f=true;if(j.indexOf(this.fields.todo_state)===-1){f=false}c=this.just_modified||false;k=this.todo_state?this.todo_state.fields.closed:false;if(this.fields.deadline_date&&!k){g=7;h=g*24*60*60*1000;a=(this.due()<h)}else{a=false}if(!f&&!a&&!c){b=false}}d=this.workspace?this.workspace.show_arx:false;if(this.fields.archived&&!d){b=false}if(this.parent_obj&&!this.workspace.show_list){if(this.parent_obj.state!=="open"){b=false}}if(this.pk===-1){b=false}return b};GtdHeading.prototype.due=function(){var c,a,b;c=null;if(this.fields.deadline_date){a=new Date();b=new Date(this.fields.deadline_date);c=b-a}return c};GtdHeading.prototype.update=function(){var a;this.expandable=this.is_expandable();if(typeof this.workspace.todo_states!=="undefined"){this.todo_state=this.workspace.todo_states.get({pk:this.fields.todo_state})}if(typeof this.workspace.headings!=="undefined"){this.children=this.workspace.headings.filter_by({parent:this.pk})}this.parent_obj=this.get_parent()};GtdHeading.prototype.save=function(b){var a,f,d,c,e;e=this;if(b===undefined){b={}}c=b.auto?true:false;a="/gtd/node/";e.fields.auto_update=c;d=jQuery.extend({},e.fields,{id:e.pk});if(e.pk>0){a+=e.pk+"/";f="PUT"}else{f="POST"}jQuery.ajax(a,{type:f,data:JSON.stringify(d),contentType:"application/json",success:function(i,g,h){e.workspace.$apply(function(){var j;if(typeof i==="string"){i=jQuery.parseJSON(i)}e.pk=i.pk;e.set_fields(i);e.update()})},error:function(i,g,h){alert("Not saved");console.error(i.responseText)},})};GtdHeading.prototype.move_to=function(h,d){var g,c,b,a,f,e;g=this;b=true;if(d===undefined){d={}}if(d.position===undefined){d.position="first-child"}if(d.save===undefined){d.save=false}a=function(){var i=true;if(g.fields.tree_id===h.fields.tree_id){if(g===h){console.error("GtdHeading refusing to move relative to itself");i=false}else{if(h.fields.lft>g.fields.lft&&h.fields.rght<g.fields.rght){console.error("GtdHeading refusing to move relative to its own child");i=false}}}return i};f=function(){var i=a();if(i===true){g.fields.parent=h.pk;g.fields.tree_id=h.fields.tree_id;g.level=h.level+1;g.rank=h.rank+1}return i};e=function(){var i=a();if(i===true){g.fields.parent=h.fields.parent;g.fields.tree_id=h.fields.tree_id;g.level=h.level;g.rank=h.rank}return i};c={"first-child":function(){var i=f();if(i===true){g.fields.lft=-1}return i},"last-child":function(){var j,i;j=f();if(j===true){i=h.get_children();g.fields.lft=i[i.length-1].fields.lft+1}return j},left:function(){var i=e();if(i===true){g.fields.lft=h.fields.lft-1}return i},right:function(){var i=e();if(i===true){g.fields.lft=h.fields.lft+1}return i}};if(typeof c[d.position]==="function"){b=c[d.position]()}else{b=false}if(b===true){h.update();g.rebuild()}return b};GtdHeading.prototype.rebuild=function(){var a,b;a=this.workspace.headings.get({tree_id:this.fields.tree_id,rank:1});b=function(f,g){var e,c,d;f.fields.lft=g;e=f.get_children();c=g+1;for(d=0;d<e.length;d+=1){c=b(e[d],c)+1}f.fields.rght=c;return c};if(a.fields.lft===undefined){a.fields.lft=1}b(a,a.fields.lft)};GtdHeading.prototype.has_scope=function(b){var a;if(b===0){a=true}else{if((b===-1)&&(this.scope.length===0)){a=true}else{if(jQuery.inArray(b,this.scope)>-1){a=true}else{a=false}}}return a};GtdHeading.prototype.set_indent=function(b,c){var a=(this.icon_width+4)*c;b.css("margin-left",a+"px")};GtdHeading.prototype.populate_children=function(b){var a,c,d;if(typeof b==="undefined"){b={}}a="/gtd/node/";c=this;d=function(e){var f,g;g=c.fields.level+e.offset;f={level:g,tree_id:c.fields.tree_id,rght__lt:c.fields.rght,lft__gt:c.fields.lft,};$.getJSON(a,f,function(i,h,j){c.workspace.$apply(function(){var k,l,n,o,m;if(h==="success"){k=i;for(l=0;l<k.length;l+=1){n=k[l];n.workspace=c.workspace;o=new GtdHeading(n);m=o.get_parent();if(m||o.rank===1){o=c.workspace.headings.add(o)}if(m){m.children.add(o);if(m.state==="open"){o.visible=true}}}if(c.rank===0){c.populated=true}if(e.offset===1){c.populated=true;c.update()}else{if(e.offset===2){for(l=0;l<c.children.length;l+=1){c.children[l].populated=true;c.children[l].update()}}}if(e.callback){e.callback()}}})})};if(!this.populated){if(this.rank>0&&this.$children){this.$children.hide()}d({offset:1,callback:function(){if(!c.populated_level_2){d({offset:2});c.populated_level_2=true}}})}else{if(!this.populated_level_2){d({offset:2});this.populated_level_2=true}}};GtdHeading.prototype.toggle=function(a){this.populate_children();if(typeof a!=="undefined"){this.state=a}else{if(this.state==="open"){this.state="closed"}else{if(this.state==="closed"){this.state="open"}}}};var HeadingManager=function(a){var b=[];b.workspace=a;return b};Array.prototype.get=function(c){var b,a;a=this.filter_by(c);if(a.length===1){b=a[0]}else{if(a.length>1){console.error("HeadingManager.get():query did not produce unique result. Returning first result");console.log(c);console.log(a);b=a[0]}else{b=null}}return b};Array.prototype.filter_by=function(g){var a,c,e,f,b,d;a=[];a.workspace=this.workspace;for(c=0;c<this.length;c+=1){e=this[c];if(e.rank===0){f=false}else{f=true}for(b in g){if(g.hasOwnProperty(b)){if(typeof e.fields!=="undefined"){if(Object.keys(e.fields).indexOf(b)>-1){d=e.fields}else{d=e}}else{d=e}if(d[b] instanceof Array){if(g[b] instanceof Array){if(!(($(e.scope).not([]).length===0&&$([]).not(e.scope).length===0)&&typeof e.scope!=="undefined")){f=false}}else{if(jQuery.inArray(g[b],d[b])<0){f=false}}}else{if(d[b]!==g[b]){f=false}}}}if(f){a.push(e)}}return a};Array.prototype.order_by=function(g){var a,b,e,c,d,f;d=["opened","closed","scheduled_date","deadline_date"];a=/^(-)?(\S*)$/.exec(g);c=a[2];b=this.slice(0);if(a[1]==="-"){f=-1}else{f=1}e=function(i,h){var n,k,m,l,j;if(typeof i.fields==="undefined"||typeof h.fields==="undefined"){n=i[c];k=h[c]}else{if(i.fields.hasOwnProperty(c)&&h.fields.hasOwnProperty(c)){n=i.fields[c];k=h.fields[c]}else{n=i[c];k=h[c]}}m=Number(n);l=Number(k);if(i.pk===0){j=-1;f=1}else{if(h.pk===0){j=1;f=1}else{if(d.indexOf(c)>-1){j=new Date(n)-new Date(k)}else{if(m&&l){j=m-l}else{n=n.toUpperCase();k=k.toUpperCase();if(n<k){j=-1}else{if(n>k){j=1}else{j=0}}}}}}return j*f};b.sort(e);return b};Array.prototype.add=function(g){var d,f,c,a,e,h,b;d=this;c=["pk","populated","text","todo_state","archived","rank","scope","parent"];e=function(k){var i,j;i=[];j=function(m){var l;f=d.get({pk:m.pk});if(f){m.populated=f.populated;for(l in m.fields){if(m.fields.hasOwnProperty(l)){f.fields[l]=m.fields[l]}}a=f}else{m.workspace=d.workspace;d.push(m);a=m}a.update();i.push(a.get_parent());return a};if(k instanceof Array){for(b=0;b<k.length;b+=1){h=new GtdHeading(k[b]);j(h)}}else{a=j(k)}i=i.filter(function(n,m,l){return l.lastIndexOf(n)===m});for(b=0;b<i.length;b+=1){if(i[b]){i[b].update()}}};if(g.$resolved===false){g.$promise.then(e)}else{e(g)}return a};Array.prototype.remove=function(c){var a,b;b=false;a=this.indexOf(c);if(a>-1){this.splice(a,1);b=true}return b};Date.prototype.ow_date=function(){var a;a=this.getFullYear()+"-"+(this.getMonth()+1)+"-"+this.getDate();return a};"use strict";var test_headings,owConfig,HeadingFactory,GtdListFactory,UpcomingFactory,outlineCtrl,listCtrl,ow_waiting;var gtd_module=angular.module("orgWolf",["ngAnimate","ngResource","ngSanitize","ngRoute"]);gtd_module.config(["$routeProvider","$locationProvider",function(b,a){a.html5Mode(true);b.when("/gtd/actions/:context_id?/:context_slug?",{templateUrl:"/static/actions-list.html",controller:"nextActionsList",}).when("/gtd/project/",{templateUrl:"/static/project-outline.html",controller:"nodeOutline"}).when("/",{redirectTo:"/gtd/project/"})}]);gtd_module.config(["$httpProvider","$locationProvider",owConfig]);function owConfig(d,b){d.defaults.headers.common["X-Request-With"]="XMLHttpRequest";function a(e){var j,h,g,f;j=null;if(document.cookie&&document.cookie!==""){h=document.cookie.split(";");for(g=0;g<h.length;g+=1){f=jQuery.trim(h[g]);if(f.substring(0,e.length+1)===(e+"=")){j=decodeURIComponent(f.substring(e.length+1));break}}}return j}var c=a("csrftoken");$.ajaxSetup({beforeSend:function(e){e.setRequestHeader("X-CSRFToken",c)}})}gtd_module.run(["$rootScope","$resource",function(c,e){var b,d,a;b=e("/gtd/todostate/");c.todo_states=b.query();d=e("/gtd/context/");c.contexts=d.query();a=e("/gtd/scope/");c.scopes=a.query()}]);gtd_module.run(["$rootScope","$location",function(a,b){a.$on("$routeChangeSuccess",function(){if(typeof ga!=="undefined"){ga("send","pageview",{page:b.path()})}})}]);gtd_module.factory("OldHeading",["$resource","$http",function(a,b){return function(c){return new GtdHeading(c)}}]);gtd_module.factory("Heading",["$resource","$http",HeadingFactory]);function HeadingFactory(b,c){var a=b("/gtd/node/:pk/",{pk:"@pk"},{query:{method:"GET",transformResponse:c.defaults.transformResponse.concat([function(e,d){return e}]),isArray:true},});return a}gtd_module.factory("Upcoming",["$resource","$http",UpcomingFactory]);function UpcomingFactory(b,c){var a=b("/gtd/node/upcoming/",{},{query:{method:"GET",transformResponse:c.defaults.transformResponse.concat([function(e,d){return e}]),isArray:true},});return a}gtd_module.factory("GtdList",["$resource","$http",GtdListFactory]);function GtdListFactory(b,c){var a=b("/gtd/lists/",{},{query:{method:"GET",transformResponse:c.defaults.transformResponse.concat([function(f,e){var d,g;for(d=0;d<f.length;d+=1){g=new GtdHeading(f[d]);jQuery.extend(f[d],g)}return f}]),isArray:true},});return a}gtd_module.filter("is_target",function(){return function(c,b){var a="";if(b){if(c.pk===b.id){a="yes"}else{if(c.fields.tree_id===b.tree_id&&c.fields.lft<b.lft&&c.fields.rght>b.rght){a="ancestor"}}}return a}});gtd_module.filter("style",function(){return function(e){var d,f,a,b;d="";if(e===null||e===undefined){d=null}else{if(e.model==="gtd.todostate"){f={};f.RED_OFFSET=16;f.GREEN_OFFSET=8;f.BLUE_OFFSET=0;f.RED_MASK=16711680;f.GREEN_MASK=65280;f.BLUE_MASK=255;f.red=(e.fields._color_rgb&f.RED_MASK)>>f.RED_OFFSET;f.green=(e.fields._color_rgb&f.GREEN_MASK)>>f.GREEN_OFFSET;f.blue=(e.fields._color_rgb&f.BLUE_MASK)>>f.BLUE_OFFSET;d+="color: rgba("+f.red+", "+f.green+", "+f.blue;d+=", "+e.fields._color_alpha+"); ";if(e.fields.actionable){d+="font-weight: bold; "}}else{if(e.fields.level>0){a=["rgb(88, 0, 176)","rgb(80, 0, 0)","rgb(0, 44, 19)","teal","slateblue","brown"];b=(e.fields.level)%a.length;d+="color: "+a[b]+"; "}}}return d}});gtd_module.filter("asHtml",["$sce",function(a){return function(c){var b=a.trustAsHtml(c);return b}}]);gtd_module.filter("order",["$sce",function(a){return function(f,e){var c,d,b;if(e==="list"){b=f.filter_by({deadline_date:null});d=$(f).not(b).get().order_by("deadline_date");c=d;c=c.concat(b.order_by("priority"))}else{c=f.order_by(e)}return c}}]);gtd_module.filter("root_cell",["$sce",function(a){return function(d){var c,b;b="";c=d.workspace.parents.get({tree_id:d.fields.tree_id,level:0});if(c){b+="<a>";b+=c.fields.title+"</a>"}b=a.trustAsHtml(b);return b}}]);gtd_module.filter("deadline_str",["$sce",function(a){return function(e){var f,c,b,d,g;f="";if(e.fields.deadline_date){f="Due ";c=new Date(e.fields.deadline_date+"T12:00:00");b=new Date();b.setHours(12,0,0,0);d=c.getTime()-b.getTime();g=Math.ceil(d/(1000*3600*24));if(g===0){f+="today"}else{if(g===-1){f+="yesterday"}else{if(g<0){f+=Math.abs(g)+" days ago"}else{if(g===1){f+="tomorrow"}else{if(g>0){f+="in "+g+" days"}}}}}}return f}}]);gtd_module.directive("owSwitch",function(){function a(f,e,c,b){function d(g){e.bootstrapSwitch("setState",g)}b.$formatters.push(d);e.on("switch-change",function(h,g){if(!f.$$phase){f.$apply(function(){b.$setViewValue(g.value)})}});e.bootstrapSwitch()}return{link:a,require:"?ngModel",}});gtd_module.directive("owEditable",["$resource",function(a){function b(g,e,d){var f,i,c,h;ow_waiting();h=a("/gtd/node/:id/",{id:"@id"});g.fields=h.get({id:d.owNodeId});g.fields.$promise.then(function(){ow_waiting("clear")});g.priorities=[{sym:"A",display:"A - high"},{sym:"B",display:"B - medium (default)"},{sym:"C",display:"C - low"}];g.time_units=[{value:"d",label:"Days"},{value:"w",label:"Weeks"},{value:"m",label:"Months"},{value:"y",label:"Years"},];g.repeat_schemes=[{value:false,label:"scheduled date"},{value:true,label:"completion date"},];f=e.find(".edit-text");c=e.find("#edit-save");$("body").animate({scrollTop:e.offset().top-27},"500");e.find("#title").focus();g.save=function(j){g.fields.text=e.find(".edit-text")[0].innerHTML;$.extend(g.heading.fields,g.fields);g.heading.update();g.heading.editable=false;g.heading.save()};g.cancel_edit=function(j){g.heading.editable=false;if(g.heading.pk===0){g.heading.pk=-1}};Aloha.ready(function(){Aloha.jQuery(e.find(".edit-text")).aloha()})}return{link:b,require:"?ngModel",templateUrl:"/static/editable.html"}}]);gtd_module.directive("owScopeTabs",["$resource",function(a){function b(f,e,d){var c;e.find('[scope_id="'+f.active_scope+'"]').addClass("active");f.change_scope=function(h){var g;e.find('[scope_id="'+f.active_scope+'"]').removeClass("active");if(h){f.active_scope=h.id}else{f.active_scope=0}e.find('[scope_id="'+f.active_scope+'"]').addClass("active")}}return{link:b,templateUrl:"/static/scope-tabs.html"}}]);gtd_module.directive("owTodo",["$filter",function(b){function a(o,g,n){var h,m,f,j,d,l,p,c;c=b("style");o.heading.todo_popover=false;m=g.children("span");if(o.heading.todo_state){m.tooltip({delay:{show:1000,hide:100},title:o.heading.todo_state.fields.display_text,placement:"right"})}function e(i){g.popover("destroy")}function k(i){$("body").append('<div id="todo-popover"></div>');l='<div class="todo-option" todo_id=""';if(o.heading.fields.todo_state===null){l+=" selected"}l+=">[None]</div>\n";for(h=0;h<o.todo_states.length;h+=1){d=o.todo_states[h];p='<div class="todo-option" todo_id="'+d.pk+'"';p+='style="'+c(d)+'"';if(d.pk===o.heading.fields.todo_state){p+=" selected"}p+=">"+d.fields.abbreviation+"</div>\n";l+=p}i.popover({title:"Todo State",content:l,html:true,container:"#todo-popover"});i.popover("show");$("body").on("click.todo_state",function(q){if(!$(q.target).hasClass("todo-state")){i.popover("destroy")}});j=$(".todo-option").not("[selected]");j.on("click.todostate",function(q){o.$apply(function(){var r=$(q.target).attr("todo_id");if(r===""){o.heading.fields.todo_state=null}else{o.heading.fields.todo_state=parseInt(r,10)}o.heading.update();o.heading.just_modified=true;o.heading.save({auto:true});e(i)})})}m.on("click",function(i){k(m)})}return{link:a,templateUrl:"/static/todo-state-selector.html",}}]);gtd_module.directive("owListRow",function(){function a(f,e,d){var c,b;b=$(e);f.$watch(function(){return f.heading.fields.deadline_date},function(){var g,h;h=f.heading.due();if(h===null){g=""}else{if(h<=0){g="overdue"}else{if(h>0){g="upcoming"}}}e.addClass(g)});f.$watch("heading.fields.archived",function(g){if(g){e.addClass("archived")}});f.$watch("heading.fields.priority",function(g,h){if(h){e.removeClass("priority-"+h)}if(g){e.addClass("priority-"+g)}});f.edit=function(g){g.editable=true}}return{link:a,scope:true,}});gtd_module.controller("inboxCapture",["$scope","$rootScope",function(b,a){b.capture=function(d){var f,c,g;c={handler_path:"plugins.quickcapture"};g=$(d.target).find("#new_inbox_item");c.subject=g.val();ow_waiting("spinner.inbox");$.ajax("/wolfmail/message/",{type:"POST",data:c,complete:function(){ow_waiting("clear.inbox")},success:function(){g.val("");a.$emit("refresh_messages")},error:function(i,e,h){alert("Failed!");console.log(e);console.log(h)}})}}]);gtd_module.controller("nodeOutline",["$scope","$http","$resource","OldHeading","Heading","$location","$anchorScroll",outlineCtrl]);function outlineCtrl(m,q,h,i,o,f,d){var j,e,c,l,g,p,a,b,k,n,r;$(".ow-active").removeClass("active");$("#nav-projects").addClass("active");n=f.hash().split("-")[0];if(n){m.target_heading=h("/gtd/node/:id/").get({id:n})}r=o.query({parent_id:0,archived:false});m.headings=new HeadingManager(m);m.children=new HeadingManager(m);m.headings.add(r);m.active_scope=0;m.sort_field="title";m.sort_fields=[{key:"title",display:"Title"},{key:"-title",display:"Title (reverse)"},{key:"-opened",display:"Creation date"},{key:"opened",display:"Creation date (oldest first)"},];if(m.parent_id===""){m.parent_id=0}else{m.parent_id=parseInt(m.parent_id,10)}m.show_arx=false;m.state="open";m.rank=0;m.update=function(){m.children=m.headings.filter_by({parent:null})};if(m.parent_id){k=o.query({tree_id:a,level__lte:b+1});m.headings.add(k);k.$promise.then(function(){var t,s;t=m.headings.get({pk:m.parent_id});s=function(v){var u;v.toggle("open");v.update();u=v.get_parent();if(u.rank!==0){s(u)}};if(t.fields.archived){m.show_arx=true}s(t);t.editable=true})}l=function(v){var s,u,t;s=$(v.delegateTarget).closest(".heading");t=Number(s.attr("node_id"));u=m.headings.get({pk:t});return u};m.edit_heading=function(s){s.populate_children();s.editable=true};m.archive_heading=function(s){if(s.fields.archived){s.fields.archived=false}else{s.fields.archived=true}s.save()};m.new_heading=function(s){var t;t=new i({id:0,workspace:s.workspace,title:"",parent:s.pk,level:s.fields.level+1,scope:s.fields.scope,});t.editable=true;t.expandable="no";s.children.add(t);m.headings.add(t);s.toggle("open")};m.toggle_node=function(s){s.toggle()};m.show_all=function(t){var s;if(m.show_arx===true){m.show_arx=false}else{m.show_arx=true}if(!m.arx_cached){s=o.query({parent_id:0,archived:true});m.headings.add(s);m.headings.add(s);m.arx_cached=true}};m.add_heading=function(s){var t;t=new i({id:0,workspace:m,title:"",parent:null,level:0,});t.editable=true;m.headings.add(t);m.children.add(t)}}gtd_module.controller("nextActionsList",["$sce","$scope","$resource","$location","$routeParams","GtdList","Heading","Upcoming",listCtrl]);function listCtrl(l,p,q,f,n,d,k,o){var e,g,m,j,c,b,h,a;$(".ow-active").removeClass("active");$("#nav-actions").addClass("active");p.list_params={};if(typeof n.context_id!=="undefined"){p.active_context=parseInt(n.context_id,10);p.context_name=n.context_slug;p.list_params.context=p.active_context}else{p.active_context=null}p.show_list=true;p.update=function(){};h=f.search().parent;if(h){h=parseInt(h,10);p.parent_id=h;p.list_params.parent=h;p.parent=q("/gtd/node/:id/").get({id:h})}a=f.search().todo_state;if(a){if(!Array.isArray(a)){a=[a]}a=a.map(function(i){return parseInt(i,10)})}else{a=[2]}p.cached_states=a.slice(0);p.active_states=a.slice(0);p.list_params.todo_state=p.active_states;j=new Date();p.scheduled=new HeadingManager(p);p.scheduled.add(k.query({field_group:"actions_list",scheduled_date__lte:j.ow_date(),todo_state:8}));b=function(i){p.headings=new HeadingManager(i);i.headings.add(d.query(i.list_params));p.headings.add(o.query())};b(p);p.show_arx=true;p.active_scope=0;p.toggle_todo_state=function(u){var s,v,t,r;v=parseInt($(u.target).attr("ow-state"),10);s=p.active_states.indexOf(v);if(s>-1){p.active_states.splice(s,1)}else{p.active_states.push(v)}if(p.cached_states.indexOf(v)===-1){p.cached_states.push(v);p.list_params.todo_state=v;p.headings.add(d.query(p.list_params))}};c=function(s){var r,i;r="/gtd/actions";if(s.active_context){r+="/"+s.active_context;r+="/"+s.context_name.toLowerCase().replace(/ /g,"-").replace(/[^\w\-]+/g,"")}f.path(r);i={};if(p.parent_id){i.parent=p.parent_id}i.todo_state=p.active_states;f.search(i)};p.change_context=function(i){p.headings=new HeadingManager(p);p.list_params.context=p.active_context;if(p.active_context){p.context_name=p.contexts.get({id:p.active_context}).name}else{delete p.context_name}p.list_params.todo_state=p.active_states;p.headings.add(d.query(p.list_params));c(p)};p.filter_parent=function(i){if(i===null){delete p.parent_id}else{p.parent_id=i.fields.root_id}c(p)}};"use strict";var Message;Message=function(a){if(a===undefined){a={}}this.fields={};this.set_fields(a)};Message.prototype.set_fields=function(a){$.extend(this.fields,a);this.pk=a.id;this.url="/wolfmail/message/"+this.pk+"/"};Message.prototype.create_node=function(d){var b,e,c,a;b=this;c={action:"create_node"};$.extend(c,d);delete c.$scope;jQuery.ajax(this.url,{type:"PUT",data:c,success:function(){d.$scope.$apply(d.$scope.success(b))},})};Message.prototype.delete_msg=function(b){var c,a;a=this;jQuery.ajax(this.url,{type:"DELETE",data:{action:"delete"},success:function(){b.$scope.$apply(b.$scope.success(a))}})};Message.prototype.archive=function(b){var c,a;a=this;jQuery.ajax(this.url,{type:"PUT",data:{action:"archive"},success:function(){b.$scope.$apply(b.$scope.success(a))}})};Message.prototype.defer=function(b){var c,a;a=this;jQuery.ajax(this.url,{type:"PUT",data:{action:"defer",target_date:b.target_date},success:function(){b.$scope.$apply(b.$scope.success(a))}})};"use strict";var MessageFactory,owinbox,owmessage;gtd_module.config(["$routeProvider","$locationProvider",function(b,a){a.html5Mode(true);b.when("/wolfmail/inbox/",{templateUrl:"/static/inbox.html",controller:"owInbox"}).when("/wolfmail/inbox/:msg_id/",{templateUrl:"/static/message.html",controller:"owMessage"})}]);gtd_module.factory("MessageAPI",["$resource","$http",MessageFactory]);function MessageFactory(b,c){var a=b("/wolfmail/message/:id",{id:"@id"},{query:{method:"GET",transformResponse:c.defaults.transformResponse.concat([function(f,e){var d,g;for(d=0;d<f.length;d+=1){g=new Message(f[d]);f[d]=g}return f}]),isArray:true},get:{method:"GET",transformResponse:c.defaults.transformResponse.concat([function(d){return new Message(d)}])}});a.prototype.create_node=Message.prototype.create_node;a.prototype.delete_msg=Message.prototype.delete_msg;a.prototype.archive=Message.prototype.archive;a.prototype.defer=Message.prototype.defer;return a}gtd_module.filter("format_sender",["$sce",function(a){return function(c){var b;if(c.fields.handler_path==="plugins.deferred"){b="";b+='<span class="dfrd">DFRD</span> Node';b=a.trustAsHtml(b)}else{if(c.fields.handler_path==="plugins.quickcapture"){b="Quick capture"}else{b=c.fields.sender}}return b}}]);gtd_module.filter("format_subject",["$sce",function(a){return function(c){var b;b="";if(c.fields.handler_path==="plugins.deferred"){b='<a href="/gtd/project/#';b+=c.fields.source_node+"-";b+=c.fields.node_slug+'">';b+=c.fields.subject;b+="</a>";b=a.trustAsHtml(b)}else{if(c.fields.handler_path==="plugins.quickcapture"){b=c.fields.subject}else{b='<a href="/wolfmail/inbox/'+c.pk+'/">';b+=c.fields.subject;b+="</a>"}}return b}}]);gtd_module.filter("format_date",function(){return function(a){var b;b=new Date(a);return b.toDateString()}});gtd_module.filter("parent_label",function(){return function(c){var b,a;b=" "+c.title;for(a=0;a<c.level;a+=1){b="---"+b}return b}});gtd_module.directive("owMessageRow",function(){function a(i,b,g){var h,j,c,k,d,f,e;h=$(b);h.find(".glyphicon").tooltip();j=h.find(".msg-task");c=h.find(".msg-project");k=h.find(".msg-complete");d=h.find(".msg-defer");f=h.find(".msg-save");e=h.find(".msg-delete");if(g.owHandler==="plugins.deferred"){c.remove();d.remove();f.remove();e.remove()}else{k.remove()}}return{link:a,}});gtd_module.directive("owMsgActions",["Heading",function(b){function a(f,e,d){var c;c=$(e);f.$task_modal=c.find(".modal.task");f.$delete_modal=c.find(".modal.delete");f.$defer_modal=c.find(".modal.defer");if(f.new_node===undefined){f.new_node={}}f.new_node.$scope=f;f.create_task_modal=function(g){f.new_node.title=g.fields.subject;if(g.fields.handler_path==="plugins.deferred"){g.create_node(f.new_node)}else{f.active_msg=g;f.modal_task=true;f.$task_modal.modal()}};f.open_task_modal=function(g){f.new_node.close=false;f.create_task_modal(g)};f.complete_task=function(g){f.new_node.close=true;f.create_task_modal(g)};f.create_project_modal=function(g){delete f.new_node.tree_id;delete f.new_node.parent;f.new_node.title=g.fields.subject;f.active_msg=g;f.modal_task=false;f.$task_modal.modal()};f.defer_modal=function(h){var g;g=new Date();f.active_msg=h;f.$defer_modal.modal();f.$defer_modal.find(".datepicker").datepicker({format:"yyyy-mm-dd",todayBtn:true,todayHighlight:true,startDate:g,})};f.delete_modal=function(g){f.active_msg=g;f.$delete_modal.modal()};f.archive_msg=function(g){g.archive(f.new_node)};f.change_project=function(g){f.parents=b.query({tree_id:g.tree_id,archived:false});f.parent=g};f.change_parent=function(g){f.new_node.parent=g.id};f.create_node=function(){f.$task_modal.modal("hide").one("hidden.bs.modal",function(){console.log(f.new_node);f.active_msg.create_node(f.new_node)})};f.defer_msg=function(){f.new_node.target_date=f.$defer_modal.find("#target-date").val();f.$defer_modal.modal("hide").one("hidden.bs.modal",function(){f.active_msg.defer(f.new_node)})};f.delete_node=function(){f.$delete_modal.modal("hide").one("hidden.bs.modal",function(){f.active_msg.delete_msg(f.new_node)})}}return{link:a,templateUrl:"/static/message-modals.html"}}]);gtd_module.controller("owInbox",["$scope","$rootScope","$resource","MessageAPI","Heading",owinbox]);function owinbox(c,a,f,d,g){var h,b,e;$(".ow-active").removeClass("active");$("#nav-inbox").addClass("active");b=new Date();c.current_date=b;c.get_messages=function(i){c.messages=d.query({in_inbox:true,now:true})};a.$on("refresh_messages",c.get_messages);c.get_messages();c.projects=g.query({parent_id:0,archived:false});c.success=function(i){c.messages.remove(i)}}gtd_module.controller("owMessage",["$scope","$routeParams","$location","MessageAPI",owmessage]);function owmessage(a,d,f,c){var e,b;b=d.msg_id;a.msg=c.get({id:b});a.success=function(g){f.path("/wolfmail/inbox")}}gtd_module.directive("owFeedback",function(){function a(f,e,d){var b,c;b=$(e);c=b.find("#feedbackModal");f.feedback={};f.send_feedback=function(g){$.ajax("/feedback/",{type:"POST",data:{body:g.text},success:function(){f.$apply(function(){f.success=true;setTimeout(function(){f.$apply(function(){f.success=false;f.feedback={};c.modal("hide")})},1200)})},error:function(i,j,h){console.log(h)}})}}return{link:a,templateUrl:"/static/feedback-modal.html"}});"use strict";$(document).ready(function(){var b,a;a=$(".persona-button");a.bind("click.persona",function(c){navigator.id.request();$(this).attr("data-loading-text","Loading...")});$("#logout").bind("click.persona",function(c){navigator.id.logout()});navigator.id.watch({loggedInUser:persona_user,onlogin:function(c){ow_waiting("spinner");$.ajax({type:"POST",url:"/accounts/login/persona/",data:{assertion:c},success:function(e,d,f){window.location.href=e.next},error:function(f,d,e){navigator.id.logout();alert("Login failure: "+e)}})},onlogout:function(){ow_waiting("spinner");$.ajax({type:"POST",url:"/accounts/logout/persona/",success:function(d,c,e){location.reload()},error:function(e,c,d){alert("Logout failure: "+d)},complete:function(d,c){ow_waiting("clear")}})}})});